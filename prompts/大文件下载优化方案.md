# å¤§æ–‡ä»¶ä¸‹è½½ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

å½“å‰é—®é¢˜ï¼š
- 21MB æ–‡ä»¶ = 213 chunks
- 30ç§’è¶…æ—¶ä¸å¤Ÿï¼ˆåŒ…å«ç½‘ç»œå»¶è¿Ÿã€æ‰¹å¤„ç†å»¶è¿Ÿï¼‰
- å¯¼è‡´å¤§æ–‡ä»¶åŒæ­¥å¤±è´¥

## æ¨èæ–¹æ¡ˆï¼šåŠ¨æ€è¶…æ—¶ + è‡ªé€‚åº”å¹¶å‘

### 1. åŠ¨æ€è¶…æ—¶ï¼ˆç®€å•æœ‰æ•ˆï¼‰

#### å®ç°ä½ç½®
`src/sync/core/common/types.ts`

```typescript
/**
 * æ ¹æ® chunk æ•°é‡åŠ¨æ€è®¡ç®—è¶…æ—¶æ—¶é—´
 */
export function calculateChunkTimeout(chunkCount: number): number {
    const BASE_TIMEOUT = 10000;      // 10ç§’åŸºç¡€æ—¶é—´
    const PER_CHUNK_TIMEOUT = 100;   // æ¯ä¸ª chunk 100ms
    const MAX_TIMEOUT = 300000;      // æœ€å¤§ 5 åˆ†é’Ÿ
    
    const calculated = BASE_TIMEOUT + chunkCount * PER_CHUNK_TIMEOUT;
    return Math.min(calculated, MAX_TIMEOUT);
}
```

#### ä¿®æ”¹ä½ç½®
`src/sync/core/managers/EntryManager/EntryManager.ts` Line 262-268

```typescript
const childrenKeys = [...meta.children] as DocumentID[];

// ğŸ”§ ä½¿ç”¨åŠ¨æ€è¶…æ—¶
const timeout = waitForReady
    ? calculateChunkTimeout(childrenKeys.length)
    : isNetworkEnabled
      ? LEAF_WAIT_ONLY_REMOTE
      : 0;

console.log(`[EntryManager] Loading ${dispFilename} with ${childrenKeys.length} chunks, timeout: ${timeout}ms`);
```

#### æ•ˆæœ
```
å°æ–‡ä»¶ (3 chunks):    10.3ç§’
ä¸­æ–‡ä»¶ (50 chunks):   15ç§’
å¤§æ–‡ä»¶ (213 chunks):  31.3ç§’
è¶…å¤§ (1000 chunks):   110ç§’
å·¨å‹ (3000+ chunks):  300ç§’ï¼ˆä¸Šé™ï¼‰
```

### 2. è‡ªé€‚åº”å¹¶å‘ï¼ˆå¯é€‰ï¼Œæå‡é€Ÿåº¦ï¼‰

#### ä¿®æ”¹ä½ç½®
`src/sync/core/managers/ChunkFetcher.ts` Line 35-37

```typescript
get concurrency(): number {
    const baseConcurrency = this.options.settings.concurrencyOfReadChunksOnline || 40;
    const queueLength = this.queue.length;
    
    // å¤§æ–‡ä»¶æ—¶è‡ªåŠ¨æé«˜å¹¶å‘
    if (queueLength > 200) {
        return Math.min(baseConcurrency * 3, 120);  // 3å€ï¼Œæœ€å¤š120
    } else if (queueLength > 100) {
        return Math.min(baseConcurrency * 2, 80);   // 2å€ï¼Œæœ€å¤š80
    }
    
    return baseConcurrency;  // é»˜è®¤40
}
```

#### æ•ˆæœ
```
å°æ–‡ä»¶ (<100 chunks):  40 å¹¶å‘
ä¸­æ–‡ä»¶ (100-200):      80 å¹¶å‘
å¤§æ–‡ä»¶ (>200):         120 å¹¶å‘

ä¸‹è½½æ—¶é—´ç¼©çŸ­çº¦ 50%
```

### 3. è¿›åº¦åé¦ˆï¼ˆå¯é€‰ï¼Œæ”¹å–„ä½“éªŒï¼‰

#### ä¿®æ”¹ä½ç½®
`src/sync/core/managers/EntryManager/EntryManager.ts` Line 271-278

```typescript
let loadedChunks = 0;
const totalChunks = childrenKeys.length;

const chunks = await this.chunkManager.read(
    childrenKeys,
    {
        skipCache: false,
        timeout: timeout,
        preventRemoteRequest: !isNetworkEnabled,
    },
    edenChunks
);

// å¦‚æœéœ€è¦è¿›åº¦åé¦ˆï¼Œå¯ä»¥åœ¨ ChunkManager ä¸­æ·»åŠ  onProgress å›è°ƒ
```

## å®æ–½ä¼˜å…ˆçº§

### Phase 1ï¼ˆå¿…é¡»ï¼Œç«‹å³å®æ–½ï¼‰
- âœ… åŠ¨æ€è¶…æ—¶è®¡ç®—
- âœ… æ·»åŠ è¶…æ—¶æ—¥å¿—

### Phase 2ï¼ˆæ¨èï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰
- ğŸ”„ è‡ªé€‚åº”å¹¶å‘
- ğŸ”„ æ‰¹å¤„ç†ä¼˜åŒ–

### Phase 3ï¼ˆå¯é€‰ï¼Œç”¨æˆ·ä½“éªŒï¼‰
- ğŸ“Š è¿›åº¦æ¡æ˜¾ç¤º
- ğŸ”” ä¸‹è½½é€šçŸ¥

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
å°æ–‡ä»¶ (<1MB):    âœ… æˆåŠŸ
ä¸­æ–‡ä»¶ (1-10MB):  âš ï¸ å¶å°”å¤±è´¥
å¤§æ–‡ä»¶ (>10MB):   âŒ ç»å¸¸å¤±è´¥
```

### ä¿®å¤å
```
å°æ–‡ä»¶ (<1MB):    âœ… æˆåŠŸ (10ç§’)
ä¸­æ–‡ä»¶ (1-10MB):  âœ… æˆåŠŸ (20ç§’)
å¤§æ–‡ä»¶ (10-50MB): âœ… æˆåŠŸ (60ç§’)
è¶…å¤§ (>50MB):     âœ… æˆåŠŸ (300ç§’ä¸Šé™)
```

## å¤‡é€‰æ–¹æ¡ˆ

å¦‚æœåŠ¨æ€è¶…æ—¶è¿˜ä¸å¤Ÿï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **åˆ†æ®µåŠ è½½**ï¼šå…ˆåŠ è½½æ–‡ä»¶å¤´ï¼Œæ˜¾ç¤ºé¢„è§ˆï¼Œåå°ç»§ç»­ä¸‹è½½
2. **æ–­ç‚¹ç»­ä¼ **ï¼šè®°å½•å·²ä¸‹è½½çš„ chunksï¼Œé‡è¯•æ—¶è·³è¿‡
3. **é¢„åŠ è½½**ï¼šåœ¨åŒæ­¥æ—¶æå‰ä¸‹è½½å¸¸ç”¨æ–‡ä»¶çš„ chunks
4. **å‹ç¼©ä¼ è¾“**ï¼šåœ¨ CouchDB å±‚å¯ç”¨ gzip å‹ç¼©

## å…¼å®¹æ€§

- âœ… ä¸å½±å“å°æ–‡ä»¶æ€§èƒ½
- âœ… å‘åå…¼å®¹ livesync
- âœ… ä¸éœ€è¦ä¿®æ”¹ core ä»£ç ï¼ˆåªä¿®æ”¹é…ç½®é€»è¾‘ï¼‰
- âœ… ä¸éœ€è¦æ¸…ç†æ•°æ®åº“

## æµ‹è¯•å»ºè®®

1. å°æ–‡ä»¶ï¼ˆ<1MBï¼Œ<10 chunksï¼‰
2. ä¸­æ–‡ä»¶ï¼ˆ1-10MBï¼Œ10-100 chunksï¼‰
3. å¤§æ–‡ä»¶ï¼ˆ10-50MBï¼Œ100-500 chunksï¼‰
4. è¶…å¤§æ–‡ä»¶ï¼ˆ>50MBï¼Œ>500 chunksï¼‰

æ¯ç§æµ‹è¯•ï¼š
- é¦–æ¬¡ä¸‹è½½
- é‡å¯åå†æ¬¡æ‰“å¼€
- ç½‘ç»œæ…¢çš„æƒ…å†µ
- å¹¶å‘å¤šä¸ªæ–‡ä»¶
