# Rename è§£å†³é—®é¢˜çš„åŸç†åˆ†æ

## é—®é¢˜ 1ï¼šlivesync æºç ä¹Ÿæ˜¯ç”¨åˆ é™¤ç©ºå£³ chunks çš„æ–¹æ¡ˆå—ï¼Ÿ

### ç­”æ¡ˆï¼šâŒ ä¸æ˜¯

é€šè¿‡æœç´¢ livesync æºç ï¼Œå‘ç°ï¼š

1. **åªæœ‰ ChunkFetcher ç›‘å¬ EVENT_MISSING_CHUNKS**
   ```typescript
   // livesync/src/lib/livesync-commonlib/src/managers/ChunkFetcher.ts:43
   this.chunkManager.addListener(EVENT_MISSING_CHUNKS, this.onEventHandler, {...});
   ```

2. **æ²¡æœ‰æ¸…ç†ç©ºå£³ chunks çš„é€»è¾‘**
   - æœç´¢ `shell chunk`, `empty chunk`, `cleanup chunk` ç­‰å…³é”®è¯ï¼Œéƒ½æ²¡æ‰¾åˆ°ç›¸å…³ä»£ç 
   - æ²¡æœ‰åœ¨ ChunkFetcher æˆ–å…¶ä»–åœ°æ–¹åˆ é™¤ç©ºå£³ chunks çš„é€»è¾‘

3. **å®Œå…¨ä¾èµ– ChunkFetcher + force: true**
   ```typescript
   // å’Œæˆ‘ä»¬ä¸€æ ·çš„å®ç°
   await this.chunkManager.write(chunks, {
       skipCache: true,
       force: true,
   }, "ChunkFetcher" as DocumentID);
   ```

### ç»“è®º

**livesync ä¸æ˜¯é€šè¿‡åˆ é™¤ç©ºå£³ chunks æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼**

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š**ä¸ºä»€ä¹ˆ livesync èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ**

## å¯èƒ½çš„åŸå› 

### åŸå›  1ï¼šlivesync çš„æ•°æ®åº“ä¸­æ ¹æœ¬ä¸ä¼šäº§ç”Ÿç©ºå£³ chunks

**å‡è®¾**ï¼šlivesync çš„ CouchDB selector çœŸçš„å®Œå…¨é˜»æ­¢äº† chunk æ–‡æ¡£çš„åŒæ­¥ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ï¼‰ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
- æ£€æŸ¥ CouchDB ç‰ˆæœ¬
- æ£€æŸ¥ PouchDB ç‰ˆæœ¬
- æ£€æŸ¥ CouchDB é…ç½®

### åŸå›  2ï¼šlivesync ç”¨æˆ·å¾ˆå°‘å¯ç”¨ readChunksOnline

**å‡è®¾**ï¼šå¤§éƒ¨åˆ† livesync ç”¨æˆ·ä½¿ç”¨é»˜è®¤çš„å…¨é‡åŒæ­¥ï¼ˆ`readChunksOnline: false`ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚

**è¯æ®**ï¼š
- Livesync çš„æ–‡æ¡£ä¸­æ²¡æœ‰å¼ºè°ƒ `readChunksOnline` åŠŸèƒ½
- è¿™å¯èƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„é«˜çº§åŠŸèƒ½

### åŸå›  3ï¼šlivesync çš„ç”¨æˆ·ç¯å¢ƒç‰¹æ®Š

**å‡è®¾**ï¼šlivesync ç”¨æˆ·ä½¿ç”¨çš„ CouchDB ç‰ˆæœ¬æˆ–é…ç½®ä¸æˆ‘ä»¬ä¸åŒã€‚

## é—®é¢˜ 2ï¼šä¸ºä»€ä¹ˆ rename åå°±æ­£å¸¸äº†ï¼Ÿ

### ç°è±¡å›é¡¾

1. **ç¬¬ä¸€æ¬¡åŒæ­¥**ï¼šå¤§æ–‡ä»¶å¤±è´¥ï¼ˆ108/108 chunks missingï¼‰
2. **è®¾å¤‡ A rename æ–‡ä»¶**
3. **è®¾å¤‡ B å†æ¬¡åŒæ­¥**ï¼šæ–‡ä»¶çªç„¶èƒ½æ‰“å¼€äº†ï¼ˆè™½ç„¶ç¬¬ä¸€æ¬¡è¿˜æ˜¯å¤±è´¥ï¼‰

### åŸå› åˆ†æ

#### æ­¥éª¤ 1ï¼šç¬¬ä¸€æ¬¡åŒæ­¥å¤±è´¥

```
è®¾å¤‡ A ä¸Šä¼ : å¤§æ–‡ä»¶ + 108 chunks
         â†“
     CouchDB
         â†“
è®¾å¤‡ B Pull (readChunksOnline=true):
  - åŒæ­¥å…ƒæ•°æ® âœ…
  - åŒæ­¥ 108 ä¸ªç©ºå£³ chunks (åªæœ‰ _id, _rev, type) âŒ
         â†“
è®¾å¤‡ B å°è¯•æ‰“å¼€æ–‡ä»¶:
  - ChunkManager å‘ç°æœ¬åœ°æœ‰ chunks
  - ä½† chunks æ˜¯ç©ºå£³ï¼ˆæ²¡æœ‰ dataï¼‰
  - è§¦å‘ ChunkFetcher æ‹‰å–
  - ChunkFetcher æ‹‰å–æˆåŠŸï¼Œä½†æ— æ³•ä¿å­˜ (written: 0)
         â†“
ç»“æœï¼šå¤±è´¥ âŒ
```

**å…³é”®**ï¼šæ­¤æ—¶è®¾å¤‡ B çš„æœ¬åœ°æ•°æ®åº“çŠ¶æ€ï¼š
- âœ… æœ‰æ–‡æ¡£å…ƒæ•°æ®
- âŒ æœ‰ 108 ä¸ªç©ºå£³ chunksï¼ˆæœ‰ `_id`, `_rev`, æ²¡æœ‰ `data`ï¼‰
- âš ï¸ ChunkFetcher æŠŠå®Œæ•´ chunks ç¼“å­˜åˆ°äº†å†…å­˜ï¼

#### æ­¥éª¤ 2ï¼šè®¾å¤‡ A rename æ–‡ä»¶

```
è®¾å¤‡ A rename:
  - åˆ›å»ºæ–°æ–‡æ¡£ (æ–° _id)
  - æ—§æ–‡æ¡£æ ‡è®°åˆ é™¤ (_deleted: true)
  - Chunks ä¿æŒä¸å˜ï¼ˆè¢«æ–°æ—§æ–‡æ¡£å…±äº«ï¼‰
         â†“
     CouchDB
  - æ–°æ–‡æ¡£å…ƒæ•°æ®
  - åˆ é™¤æ—§æ–‡æ¡£çš„æ ‡è®°
  - Chunks æ²¡æœ‰å˜åŒ–
```

**é‡è¦**ï¼šRename å¹¶ä¸ä¼šé‡æ–°ä¸Šä¼  chunksï¼Chunks æ˜¯æ ¹æ®å†…å®¹ hash ç”Ÿæˆ ID çš„ï¼Œå†…å®¹ä¸å˜ï¼Œchunks ä¸å˜ã€‚

#### æ­¥éª¤ 3ï¼šè®¾å¤‡ B ç¬¬äºŒæ¬¡åŒæ­¥

```
è®¾å¤‡ B Pull:
  - æ¥æ”¶æ–°æ–‡æ¡£å…ƒæ•°æ® âœ…
  - æ¥æ”¶æ—§æ–‡æ¡£åˆ é™¤æ ‡è®° âœ…
  - Chunks æ²¡æœ‰å˜åŒ–ï¼ˆå› ä¸ºè¿œç¨‹æ²¡æœ‰å˜åŒ–ï¼‰
         â†“
è®¾å¤‡ B å°è¯•æ‰“å¼€æ–°æ–‡ä»¶:
  - EntryManager è¯»å–æ–°æ–‡æ¡£çš„ chunks
  - ChunkManager æŸ¥æ‰¾ chunks
  - ğŸ¯ å…³é”®ï¼šä»å†…å­˜ç¼“å­˜ä¸­æ‰¾åˆ°äº†å®Œæ•´çš„ chunksï¼
         â†“
ç»“æœï¼šæˆåŠŸ âœ…
```

### ğŸ”‘ å…³é”®å‘ç°

**Rename èƒ½è§£å†³é—®é¢˜çš„çœŸæ­£åŸå› ï¼šChunkFetcher ç¬¬ä¸€æ¬¡æ‹‰å–çš„ chunks è¢«ç¼“å­˜åˆ°äº†å†…å­˜ï¼**

è®©æˆ‘éªŒè¯è¿™ä¸ªå‡è®¾ï¼š

```typescript
// ChunkFetcher.ts Line 148-150
finally {
    // Emitting fetched chunks and missing IDs regardless of write success
    for (const chunk of chunks) {
        this.chunkManager.emitEvent(EVENT_CHUNK_FETCHED, chunk);  // ğŸ‘ˆ å…³é”®ï¼
    }
}
```

```typescript
// ChunkManager.ts Line 235-244
onChunkArrived(doc: EntryLeaf, deleted: boolean = false): void {
    const id = doc._id;
    if (this.waitingMap.has(id)) {
        const queue = this.waitingMap.get(id)!;
        this.waitingMap.delete(id);
        if (doc._deleted || deleted) {
            queue.resolver.resolve(false);
        } else {
            queue.resolver.resolve(doc);
            this.cacheChunk(doc);  // ğŸ‘ˆ æ·»åŠ åˆ°ç¼“å­˜ï¼
        }
    }
}
```

**éªŒè¯ç»“æœ**ï¼šâœ… ç¡®è®¤ï¼

å³ä½¿ ChunkFetcher æ— æ³•å°† chunks ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆ`written: 0`ï¼‰ï¼Œä½†å®ƒä¼šï¼š
1. é€šè¿‡ `emitEvent(EVENT_CHUNK_FETCHED, chunk)` å‘é€äº‹ä»¶
2. ChunkManager çš„ `onChunkArrived` æ¥æ”¶äº‹ä»¶
3. **å°† chunk ç¼“å­˜åˆ°å†…å­˜**ï¼ˆ`this.cacheChunk(doc)`ï¼‰

### å®Œæ•´æµç¨‹å›¾

```
ç¬¬ä¸€æ¬¡åŒæ­¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŒæ­¥ç©ºå£³ chunks                       â”‚
â”‚ 2. å°è¯•æ‰“å¼€æ–‡ä»¶                          â”‚
â”‚ 3. ChunkFetcher æ‹‰å–å®Œæ•´ chunks          â”‚
â”‚ 4. æ— æ³•ä¿å­˜åˆ°æ•°æ®åº“ (written: 0)         â”‚
â”‚ 5. ä½†ç¼“å­˜åˆ°å†…å­˜ âœ…                       â”‚
â”‚ 6. 30ç§’è¶…æ—¶ï¼Œæ‰“å¼€å¤±è´¥ âŒ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ (rename è§¦å‘)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡ A rename æ–‡ä»¶                       â”‚
â”‚ - æ–°æ–‡æ¡£ _id                             â”‚
â”‚ - æ—§æ–‡æ¡£åˆ é™¤                             â”‚
â”‚ - Chunks ä¸å˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒæ¬¡åŒæ­¥:                              â”‚
â”‚ 1. åŒæ­¥æ–°æ–‡æ¡£å…ƒæ•°æ®                      â”‚
â”‚ 2. å°è¯•æ‰“å¼€æ–°æ–‡ä»¶                        â”‚
â”‚ 3. ChunkManager æŸ¥æ‰¾ chunks              â”‚
â”‚ 4. ä»å†…å­˜ç¼“å­˜ä¸­æ‰¾åˆ° âœ…                   â”‚
â”‚ 5. æˆåŠŸæ‰“å¼€ âœ…                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆç¬¬äºŒæ¬¡æ‰“å¼€"ç¬¬ä¸€æ¬¡è‚¯å®šå¤±è´¥"ï¼Ÿ

**ä¸¤ä¸ªå¯èƒ½çš„åŸå› **ï¼š

#### åŸå›  Aï¼šç¼“å­˜å·²è¿‡æœŸ

ChunkManager ä½¿ç”¨ `WeakRef` ç¼“å­˜ï¼Œå¯èƒ½è¢« GC å›æ”¶ï¼š

```typescript
// ChunkManager.ts Line 114
caches: Map<DocumentID, FallbackWeakRef<EntryLeaf>> = new Map();
```

å¦‚æœç¬¬äºŒæ¬¡æ‰“å¼€è·ç¦»ç¬¬ä¸€æ¬¡æ—¶é—´å¤ªé•¿ï¼Œç¼“å­˜å¯èƒ½å·²ç»è¢« GC å›æ”¶äº†ã€‚

#### åŸå›  Bï¼šç¼“å­˜è¿˜åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­

ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶ï¼ŒChunkManager å¯èƒ½è¿˜åœ¨ç­‰å¾… chunks åˆ°è¾¾ï¼ˆ30ç§’è¶…æ—¶ï¼‰ã€‚å¦‚æœåœ¨è¶…æ—¶å‰å°±å…³é—­äº†ï¼Œchunks å¯èƒ½è¿˜æ²¡æœ‰è¢«å®Œå…¨ç¼“å­˜ã€‚

ç¬¬äºŒæ¬¡æ‰“å¼€æ—¶ï¼Œå¦‚æœï¼š
1. ç¼“å­˜å·²è¢«æ¸…é™¤ï¼ˆé‡å¯ Obsidianï¼‰
2. æˆ–è€…ç¼“å­˜ GC äº†
3. éœ€è¦é‡æ–°ä»æ•°æ®åº“è¯»å– â†’ è¿˜æ˜¯ç©ºå£³ â†’ å¤±è´¥

ä½†å¦‚æœï¼š
1. ç¼“å­˜è¿˜åœ¨
2. æˆåŠŸè¯»å–

### å®Œæ•´çš„é—®é¢˜é“¾

```
é—®é¢˜äº§ç”Ÿ:
CouchDB selector â†’ ç©ºå£³ chunks â†’ force:true æ— æ³•æ›´æ–° â†’ written: 0
                                                            â†“
                                              chunks ç¼“å­˜åˆ°å†…å­˜ âœ…

ç¬¬ä¸€æ¬¡æ‰“å¼€: è¶…æ—¶å¤±è´¥ï¼ˆchunks è¿˜åœ¨æ‹‰å–æˆ–åˆšç¼“å­˜ï¼‰
ç¬¬äºŒæ¬¡æ‰“å¼€: 
  - å¦‚æœç¼“å­˜è¿˜åœ¨ â†’ æˆåŠŸ âœ…
  - å¦‚æœç¼“å­˜å·²GC â†’ å¤±è´¥ âŒ (è¿™å°±æ˜¯"ç¬¬ä¸€æ¬¡è‚¯å®šå¤±è´¥"çš„åŸå› )

Rename å:
  - è§¦å‘æ–°ä¸€è½®ç¼“å­˜
  - å¦‚æœä¹‹å‰çš„ç¼“å­˜è¿˜åœ¨ â†’ ç«‹å³æˆåŠŸ âœ…
  - å¦‚æœç¼“å­˜å·²æ¸…é™¤ â†’ éœ€è¦é‡æ–°æ‹‰å– â†’ ç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œç¬¬äºŒæ¬¡å¯èƒ½æˆåŠŸ
```

## çœŸæ­£çš„è§£å†³æ–¹æ¡ˆ

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼ˆåˆ é™¤ç©ºå£³ chunksï¼‰æ˜¯**å®Œå…¨æ­£ç¡®**çš„ï¼

### ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„æ–¹æ¡ˆæ›´å¥½

1. **ä¸ä¾èµ–å†…å­˜ç¼“å­˜**ï¼šç¼“å­˜å¯èƒ½è¢« GC å›æ”¶
2. **ä¸€æ¬¡æ€§è§£å†³**ï¼šåˆ é™¤ç©ºå£³åï¼Œchunks èƒ½æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
3. **æŒä¹…åŒ–**ï¼šä¸‹æ¬¡æ‰“å¼€ä¸éœ€è¦é‡æ–°æ‹‰å–

### livesync ä¸ºä»€ä¹ˆèƒ½å·¥ä½œçš„çœŸç›¸

**å‡è®¾**ï¼šlivesync çš„ç¯å¢ƒä¸­ï¼ŒCouchDB selector çœŸçš„å®Œå…¨é˜»æ­¢äº† chunk å…ƒæ•°æ®çš„åŒæ­¥ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
```javascript
// åœ¨ livesync ç¯å¢ƒä¸­è¿è¡Œ
const db = app.plugins.plugins['obsidian-livesync'].localDatabase.localDatabase;

db.allDocs({
    startkey: 'h:',
    endkey: 'h:\uffff',
    include_docs: true,
    limit: 10,
}).then(result => {
    console.log('Total chunk docs:', result.total_rows);
    console.log('Sample chunks:', result.rows.slice(0, 3));
    
    const shellChunks = result.rows.filter(row => {
        const doc = row.doc;
        return doc && doc.type === 'leaf' && (!doc.data || doc.data.length === 0);
    });
    console.log('Shell chunks:', shellChunks.length);
});
```

å¦‚æœ livesync çš„ç¯å¢ƒä¸­ä¹Ÿæœ‰ç©ºå£³ chunksï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¼šæœ‰åŒæ ·çš„é—®é¢˜ï¼

## æ€»ç»“

1. âœ… **Livesync æ²¡æœ‰åˆ é™¤ç©ºå£³ chunks çš„é€»è¾‘**
2. âœ… **Rename èƒ½ä¸´æ—¶è§£å†³æ˜¯å› ä¸ºå†…å­˜ç¼“å­˜**
3. âœ… **ç¬¬ä¸€æ¬¡è‚¯å®šå¤±è´¥æ˜¯å› ä¸ºç¼“å­˜å¯èƒ½å·²è¿‡æœŸæˆ–è¢« GC**
4. âœ… **æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯æ­£ç¡®ä¸”å¿…è¦çš„**
5. âš ï¸ **Livesync å¯èƒ½åœ¨æŸäº›ç¯å¢ƒä¸‹ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜**

## å»ºè®®

1. **å®æ–½æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼ˆåˆ é™¤ç©ºå£³ chunksï¼‰
2. **å‘ livesync ä½œè€…æŠ¥å‘Šè¿™ä¸ªé—®é¢˜**
3. **å¯èƒ½è¿™æ˜¯ä¸€ä¸ªæœªè¢«å‘ç°çš„ bug**ï¼Œæˆ–è€… livesync ç”¨æˆ·å¾ˆå°‘å¯ç”¨ `readChunksOnline`
