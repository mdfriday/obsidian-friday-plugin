# å¤šè®¾å¤‡åŒæ­¥æ•°æ®å›æ»šé—®é¢˜ - æ·±åº¦åˆ†ææŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆçš„ç°è±¡ï¼š
1. **ç”µè„‘**ï¼šæœ€æ–°ç‰ˆæœ¬ï¼ˆå­¦ä¹ å®Œæˆåï¼‰
2. **æ‰‹æœº**ï¼šæ¬¡æ—©ç‰ˆæœ¬ï¼ˆå­¦ä¹ å‰çš„ç‰ˆæœ¬ï¼‰
3. **å¹³æ¿**ï¼šå¤æ—©ç‰ˆæœ¬ï¼ˆå¾ˆä¹…æ²¡æ‰“å¼€ï¼‰

### å¤ç°æ­¥éª¤ä¸ç°è±¡

```mermaid
sequenceDiagram
    participant ç”µè„‘ as ç”µè„‘(æœ€æ–°)
    participant æœåŠ¡å™¨ as CouchDBæœåŠ¡å™¨
    participant æ‰‹æœº as æ‰‹æœº(æ¬¡æ—©)
    participant å¹³æ¿ as å¹³æ¿(å¤æ—©)
    
    Note over ç”µè„‘,æœåŠ¡å™¨: 1. ç”µè„‘å­¦ä¹ å®Œæˆï¼Œæ•°æ®å·²åŒæ­¥
    ç”µè„‘->>æœåŠ¡å™¨: æ¨é€æœ€æ–°æ•°æ®
    
    Note over æ‰‹æœº: 2. æ‰‹æœºæ‰“å¼€åŒæ­¥
    æ‰‹æœº->>æœåŠ¡å™¨: è¯·æ±‚åŒæ­¥
    æœåŠ¡å™¨-->>æ‰‹æœº: ä¸‹è½½æœ€æ–°æ•°æ®(?)
    æ‰‹æœº->>æ‰‹æœº: ç¼–è¾‘å†…å®¹
    æ‰‹æœº->>æœåŠ¡å™¨: æ¨é€ä¿®æ”¹
    
    Note over ç”µè„‘: 3. ç”µè„‘æ‰“å¼€å...
    ç”µè„‘->>æœåŠ¡å™¨: åŒæ­¥
    æœåŠ¡å™¨-->>ç”µè„‘: âŒå˜æˆæ‰‹æœºçš„æ¬¡æ—©ç‰ˆæœ¬ï¼
    Note over ç”µè„‘: æ‰‹æœºç¼–è¾‘çš„å†…å®¹ä¸¢å¤±ï¼
    
    Note over å¹³æ¿: 4. æ‰“å¼€å¹³æ¿å...
    å¹³æ¿->>æœåŠ¡å™¨: åŒæ­¥
    æœåŠ¡å™¨-->>ç”µè„‘: âŒç”µè„‘å˜æˆå¤æ—©ç‰ˆæœ¬ï¼
    æœåŠ¡å™¨-->>å¹³æ¿: âŒå¹³æ¿å˜æˆæ¬¡æ—©ç‰ˆæœ¬ï¼
    
    Note over ç”µè„‘,å¹³æ¿: ğŸ˜±æ‰€æœ‰è®¾å¤‡æ•°æ®å›æ»šåˆ°ä¸åŒçš„æ—§ç‰ˆæœ¬
```

## æ ¸å¿ƒé—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šé•¿æœŸç¦»çº¿è®¾å¤‡çš„ Checkpoint é™·é˜±

#### æºç è¯æ®

**ReplicatorShim.ts (lines 99-122):**

```typescript
// Checkpoint retrieval
// The checkpoint is a document that stores the last sequence number that has been replicated.
// We can track the changes efficiently by using the checkpoint.
const sourceCheckpointID = `_local/replication-checkpoint-mark-${targetDBName}-${sourceDBName}`;
const sourceCheckpointData = await upsert<{ mark: string }>(sourceDB, sourceCheckpointID, (doc) => {
    const previousMark: string = doc.mark ?? new Date().getTime().toString();
    const mark = option.rewind ? new Date().getTime().toString() : previousMark;
    return {
        ...doc,
        mark: mark,
    };
});
```

**é—®é¢˜åˆ†æï¼š**

1. **å¹³æ¿ä¸Šçš„å¤è€ Checkpointï¼š**
   - å¹³æ¿å¾ˆä¹…æ²¡æ‰“å¼€ï¼Œæœ¬åœ° PouchDB ä¸­å­˜å‚¨çš„ checkpoint æ˜¯å‡ ä¸ªæœˆå‰çš„
   - Checkpoint è®°å½•çš„ `since` åºåˆ—å·æŒ‡å‘å¤è€çš„ CouchDB update_seq
   - å½“å¹³æ¿åŒæ­¥æ—¶ï¼Œå®ƒä¼šä»è¿™ä¸ªå¤è€çš„åºåˆ—å·å¼€å§‹æ‹‰å–å˜æ›´

2. **æ—¶é—´çª—å£é—®é¢˜ï¼š**
   ```
   æ—¶é—´çº¿ï¼š
   T0: å¹³æ¿æœ€åä¸€æ¬¡åŒæ­¥ (update_seq = 100)
   T1: ç”µè„‘å­¦ä¹ å‰çš„çŠ¶æ€ (update_seq = 500)  <- æ‰‹æœºçŠ¶æ€
   T2: ç”µè„‘å­¦ä¹ åçš„çŠ¶æ€ (update_seq = 1000) <- ç”µè„‘çŠ¶æ€
   T3: ç°åœ¨å¹³æ¿æ‰“å¼€ (æœ¬åœ°checkpoint still at seq=100)
   ```

3. **å¢é‡åŒæ­¥çš„é™·é˜±ï¼š**
   - å¹³æ¿è¯·æ±‚ä» seq=100 å¼€å§‹çš„æ‰€æœ‰å˜æ›´
   - CouchDB è¿”å› seq=100 åˆ° seq=1000 çš„æ‰€æœ‰æ–‡æ¡£ä¿®è®¢
   - **å…³é”®é—®é¢˜**ï¼šå¦‚æœä¸­é—´æœ‰æ–‡æ¡£è¢«åˆ é™¤åˆé‡æ–°åˆ›å»ºï¼Œrevision tree å¯èƒ½æ–­è£‚

### é—®é¢˜2ï¼šPouchDB Revision Tree çš„å†²çªè§£å†³ç­–ç•¥

#### CouchDB çš„ MVCC æœºåˆ¶

**æ ¸å¿ƒåŸç†ï¼š**
- CouchDB ä½¿ç”¨ revision tree æ¥è¿½è¸ªæ–‡æ¡£çš„æ‰€æœ‰å†å²ç‰ˆæœ¬
- æ¯ä¸ªæ–‡æ¡£æœ‰å”¯ä¸€çš„ `_rev` (revision ID)ï¼Œæ ¼å¼ä¸º `N-hash`
  - N = revision åºå·
  - hash = å†…å®¹å“ˆå¸Œ

**bulkDocs with new_edits: false çš„è¡Œä¸ºï¼š**

```typescript
// ReplicatorShim.ts line 185
await targetDB.bulkDocs(fetchedMissingDocs, { new_edits: false });
// new_edits = false: means that we aimed to write the docs as they are, 
// even if they are conflicted.
```

**è¿™æ„å‘³ç€ï¼š**
1. æ–‡æ¡£ä¼šè¢«åŸæ ·å†™å…¥ï¼Œä¿ç•™å…¶ `_rev`
2. ä¸ä¼šè‡ªåŠ¨è§£å†³å†²çªï¼Œè€Œæ˜¯åˆ›å»ºå†²çªåˆ†æ”¯
3. PouchDB ä¼šä¿ç•™å¤šä¸ªå†²çªçš„ revision

### é—®é¢˜3ï¼šå†²çªè§£å†³ç­–ç•¥çš„è‡´å‘½ç¼ºé™·

#### å½“å‰çš„å†²çªè§£å†³é€»è¾‘

**HiddenFileSync - resolveByNewerEntry (lines 1178-1218):**

```typescript
private async resolveByNewerEntry(
    id: DocumentID,
    path: FilePathWithPrefix,
    currentDoc: MetaEntry,
    currentRev: string,
    conflictedRev: string
): Promise<void> {
    // Get the conflicted document
    const conflictedDoc = await localDB.getRaw<MetaEntry>(id, { rev: conflictedRev });
    
    // Compare mtime to determine which is newer
    const mtimeCurrent = getComparingMTime(currentDoc, true);
    const mtimeConflicted = getComparingMTime(conflictedDoc, true);
    
    // Delete the older revision
    const deleteRev = mtimeCurrent < mtimeConflicted ? currentRev : conflictedRev;
    await localDB.removeRevision(id, deleteRev);
}
```

**FridayServiceHub - defaultProcessSynchroniseResult (lines 417-428):**

```typescript
// 1. Check mtime freshness (2 second resolution)
const localMtime = existingFile.stat.mtime;
const remoteMtime = fullEntry.mtime || 0;

const mtimeComparison = compareMtime(localMtime, remoteMtime);

if (mtimeComparison !== "EVEN") {
    // Mtime is significantly different
    shouldWrite = true;
}
```

**è‡´å‘½é—®é¢˜ï¼š**

1. **mtime åªæœ‰ 2 ç§’ç²¾åº¦ï¼š**
   ```typescript
   // FridayStorageEventManager.ts lines 52-65
   const MTIME_RESOLUTION = 2000; // 2 seconds
   
   export function compareMtime(baseMTime: number, targetMTime: number) {
       const truncatedBaseMTime = Math.floor(baseMTime / MTIME_RESOLUTION) * MTIME_RESOLUTION;
       const truncatedTargetMTime = Math.floor(targetMTime / MTIME_RESOLUTION) * MTIME_RESOLUTION;
       if (truncatedBaseMTime === truncatedTargetMTime) return "EVEN";
       if (truncatedBaseMTime > truncatedTargetMTime) return "BASE_IS_NEW";
       return "TARGET_IS_NEW";
   }
   ```

2. **é—®é¢˜åœºæ™¯ï¼š**
   - æ—§è®¾å¤‡ä¸Šçš„æ–‡æ¡£ mtime å¯èƒ½æ¯”æ–°ç‰ˆæœ¬çš„ mtime æ›´æ–°ï¼ˆå› ä¸ºå®ƒæ˜¯åŸºäºæœ¬åœ°æ—¶é’Ÿï¼‰
   - å¦‚æœæ—§è®¾å¤‡åœ¨æœ¬åœ°åšäº†ä¿®æ”¹ï¼ˆå“ªæ€•æ˜¯å†²çªè§£å†³ï¼‰ï¼Œmtime ä¼šæ›´æ–°
   - å†²çªè§£å†³æ—¶ä¼šé€‰æ‹© mtime æ›´æ–°çš„ç‰ˆæœ¬ï¼Œ**å³ä½¿å†…å®¹æ˜¯æ—§çš„**

### é—®é¢˜4ï¼šè®¾å¤‡é•¿æœŸç¦»çº¿åçš„"æ—¶é—´å·®"é—®é¢˜

#### åœºæ™¯é‡ç°

**æ‰‹æœºé•¿æœŸæœªæ‰“å¼€çš„æƒ…å†µï¼š**

```typescript
// æ‰‹æœºä¸Šçš„çŠ¶æ€ï¼š
localDB.info() => {
    update_seq: 500,  // åœç•™åœ¨å­¦ä¹ å‰
    doc_count: 1000
}

// æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€ï¼š
remoteDB.info() => {
    update_seq: 1000, // å­¦ä¹ åçš„çŠ¶æ€
    doc_count: 1200
}
```

**åŒæ­¥æµç¨‹ï¼š**

1. **æ‰‹æœºæ‹‰å–å˜æ›´ (Pull)ï¼š**
   ```typescript
   // LiveSyncReplicator.ts - openContinuousReplication (line 1110)
   if (await this.openOneShotReplication(setting, showResult, false, "pullOnly")) {
       // ...
   }
   ```

2. **é—®é¢˜å‡ºç°æ—¶æœºï¼š**
   - æ‰‹æœºä» seq=500 æ‹‰å–åˆ° seq=1000 çš„æ‰€æœ‰å˜æ›´
   - å¦‚æœæ‰‹æœºçš„æœ¬åœ° PouchDB ä¸­å·²ç»æœ‰ä¸€äº›"è„æ•°æ®"ï¼ˆæœªåŒæ­¥çš„æœ¬åœ°ä¿®æ”¹ï¼‰
   - è¿™äº›è„æ•°æ®çš„ revision å·å¯èƒ½ä¸æœåŠ¡å™¨å†²çª

3. **å†²çªäº§ç”Ÿï¼š**
   ```
   æœåŠ¡å™¨æ–‡æ¡£:  _id: "file1.md", _rev: "5-abc" (æ–°å†…å®¹)
   æ‰‹æœºæœ¬åœ°æ–‡æ¡£: _id: "file1.md", _rev: "3-xyz" (æ—§å†…å®¹ï¼Œä½†æœ‰æœªåŒæ­¥çš„ä¿®æ”¹)
   
   â†’ PouchDB æ£€æµ‹åˆ°å†²çª
   â†’ ä¸¤ä¸ª revision éƒ½ä¿ç•™åœ¨ revision tree
   â†’ å“ªä¸ªæˆä¸º"winning revision"ï¼Ÿ
   ```

#### PouchDB çš„ Winning Revision é€‰æ‹©ç®—æ³•

**ç®—æ³•è§„åˆ™ï¼ˆä» PouchDB æºç ï¼‰ï¼š**

```javascript
// PouchDB å†…éƒ¨ç®—æ³•
function winningRev(metadata) {
    // 1. é€‰æ‹© revision number æœ€å¤§çš„åˆ†æ”¯
    // 2. å¦‚æœ revision number ç›¸åŒï¼ŒæŒ‰ revision hash å­—å…¸åºæ’åº
    // 3. deleted çš„ revision ä¼˜å…ˆçº§ä½
    
    var winningRev;
    var winningRevPos;
    var len = metadata.rev_tree.length;
    
    for (var i = 0; i < len; i++) {
        var rev = metadata.rev_tree[i];
        var pos = rev.pos;
        var hash = rev.ids[0];
        
        if (!winningRev || pos > winningRevPos || 
            (pos === winningRevPos && hash > winningRev)) {
            winningRev = hash;
            winningRevPos = pos;
        }
    }
    
    return winningRevPos + '-' + winningRev;
}
```

**é—®é¢˜ï¼š**
- Revision number å¤§çš„ä¸ä¸€å®šæ˜¯å†…å®¹æ–°çš„
- æ—§è®¾å¤‡å¯èƒ½å› ä¸ºæœ¬åœ°ä¿®æ”¹äº§ç”Ÿäº†æ›´é«˜çš„ revision number
- **å¯¼è‡´æ—§å†…å®¹è¢«é€‰ä¸º winning revision**

### é—®é¢˜5ï¼šæ‰‹æœº"ä¸‹è½½äº†æœ€æ–°ç‰ˆæœ¬"åä¸ºä½•è¿˜ä¼šå›æ»š

#### å…³é”®ä»£ç è·¯å¾„

**1. åˆå§‹åŒæ­¥ (Pull from Server):**

```typescript
// LiveSyncReplicator.ts - openOneShotReplication
async openOneShotReplication(
    setting: RemoteDBSettings,
    showResult: boolean,
    retrying: boolean,
    syncMode: "sync" | "pullOnly" | "pushOnly",
    ignoreCleanLock = false
): Promise<boolean> {
    // ...
    
    // Pull from server
    if (syncMode === "pullOnly" || syncMode === "sync") {
        await replicateShim(localDB, remoteDB, progressCallback, {
            rewind: false  // ä¸é‡ç½® checkpoint
        });
    }
}
```

**2. é—®é¢˜ï¼šä¸‹è½½åæœ¬åœ°çŠ¶æ€ä¸ä¸€è‡´**

```typescript
// åœºæ™¯ï¼šæ‰‹æœºä¸‹è½½æœ€æ–°ç‰ˆæœ¬
// Step 1: Pull from server (æ‹‰å– seq=500 åˆ° seq=1000)
remoteDocs.forEach(doc => {
    localDB.bulkDocs([doc], { new_edits: false });
    // æ–‡æ¡£è¢«å†™å…¥ï¼Œä½†å¯èƒ½åˆ›å»ºå†²çª
});

// Step 2: æ‰‹æœºç”¨æˆ·ç«‹å³ç¼–è¾‘æ–‡ä»¶
// é—®é¢˜ï¼šç¼–è¾‘çš„æ˜¯å“ªä¸ª revisionï¼Ÿ
vault.modify(file) => {
    // Obsidian è¯»å–çš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Ÿ
    // å¦‚æœæœ‰å†²çªï¼Œè¯»å–çš„æ˜¯ winning revision
    // ä½† winning revision å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼
}
```

**3. å†²çªæ£€æµ‹çš„æ—¶æœºé—®é¢˜ï¼š**

```typescript
// FridayServiceHub.ts - defaultProcessSynchroniseResult
private async defaultProcessSynchroniseResult(doc: MetaEntry): Promise<boolean> {
    // åŒæ­¥ç»“æœåˆ°è¾¾åæ‰å¤„ç†
    // ä½†æ­¤æ—¶ç”¨æˆ·å¯èƒ½å·²ç»åœ¨ç¼–è¾‘æ–‡ä»¶äº†ï¼
    
    // Check if this is an internal file
    const isInternalFile = isInternalMetadata(doc._id);
    
    if (isInternalFile) {
        // å†…éƒ¨æ–‡ä»¶ç”± HiddenFileSync å¤„ç†
        await this.core.hiddenFileSync?.trackDatabaseFileModification(doc);
    } else {
        // æ™®é€šæ–‡ä»¶ç›´æ¥å†™å…¥
        await this.core.entryManager.dbToStorage(doc.path, true);
    }
}
```

**4. ç«æ€æ¡ä»¶ï¼š**

```
æ—¶é—´çº¿ï¼š
T0: æ‰‹æœºå¼€å§‹åŒæ­¥ (çŠ¶æ€: seq=500)
T1: æ”¶åˆ°æ–‡æ¡£ "note.md" rev="5-abc" (æœ€æ–°ç‰ˆæœ¬)
T2: å†™å…¥æœ¬åœ° PouchDB (å¯èƒ½åˆ›å»ºå†²çª)
T3: ç”¨æˆ·æ‰“å¼€ note.md å¼€å§‹ç¼–è¾‘
T4: å†²çªè§£å†³å™¨è¿è¡Œï¼Œé€‰æ‹©äº†æ—§ revision ä½œä¸º winning
T5: ç”¨æˆ·ä¿å­˜ä¿®æ”¹
T6: åŸºäºæ—§å†…å®¹çš„ä¿®æ”¹è¢«æ¨é€åˆ°æœåŠ¡å™¨
```

## æ ¹æœ¬åŸå› æ€»ç»“

### 1. **Checkpoint æœºåˆ¶çš„å‡è®¾å¤±æ•ˆ**
   - è®¾è®¡å‡è®¾ï¼šè®¾å¤‡å®šæœŸåŒæ­¥ï¼Œcheckpoint ä¿æŒæ›´æ–°
   - å®é™…æƒ…å†µï¼šè®¾å¤‡é•¿æœŸç¦»çº¿ï¼Œcheckpoint ä¸¥é‡è¿‡æ—¶
   - åæœï¼šæ‹‰å–æµ·é‡å†å²å˜æ›´ï¼Œrevision tree å¤æ‚åº¦çˆ†ç‚¸

### 2. **Revision Tree å†²çªè§£å†³çš„ç®—æ³•ç¼ºé™·**
   - Winning revision é€‰æ‹©åŸºäº revision numberï¼Œä¸åŸºäºæ—¶é—´æˆ³
   - æ—§è®¾å¤‡çš„æœ¬åœ°ä¿®æ”¹å¯èƒ½äº§ç”Ÿæ›´é«˜çš„ revision number
   - å¯¼è‡´æ—§å†…å®¹è¢«é€‰ä¸º winning revision

### 3. **mtime æ¯”è¾ƒçš„ç²¾åº¦å’Œå¯é æ€§é—®é¢˜**
   - 2 ç§’ç²¾åº¦ä¸è¶³ä»¥åŒºåˆ†å¿«é€Ÿç¼–è¾‘
   - ä¾èµ–è®¾å¤‡æœ¬åœ°æ—¶é’Ÿï¼Œå¯èƒ½ä¸åŒæ­¥
   - æ—§è®¾å¤‡çš„ mtime å¯èƒ½æ¯”æ–°å†…å®¹è¿˜æ–°

### 4. **ç¼ºå°‘"æ•°æ®åº“ç‰ˆæœ¬"æ£€æµ‹æœºåˆ¶**
   - æ²¡æœ‰å…¨å±€çš„"æ•°æ®åº“ä»£"æ ‡è¯†
   - æ— æ³•æ£€æµ‹è®¾å¤‡æ˜¯å¦"è¿‡äºé™ˆæ—§"
   - Salt æ£€æŸ¥åªèƒ½æ£€æµ‹è¿œç¨‹é‡ç½®ï¼Œä¸èƒ½æ£€æµ‹æœ¬åœ°è¿‡æ—¶

### 5. **åŒæ­¥ä¸ç”¨æˆ·æ“ä½œçš„ç«æ€æ¡ä»¶**
   - æ–‡æ¡£ä¸‹è½½å’Œå†²çªè§£å†³æ˜¯å¼‚æ­¥çš„
   - ç”¨æˆ·å¯èƒ½åœ¨å†²çªè§£å†³å‰å°±å¼€å§‹ç¼–è¾‘
   - ç¼ºå°‘"åŒæ­¥å®Œæˆå‰é”å®šç¼–è¾‘"çš„æœºåˆ¶

## ç”¨æˆ·æ¡ˆä¾‹ä¸­çš„å…·ä½“é—®é¢˜æµç¨‹

### åœºæ™¯1ï¼šæ‰‹æœºåŒæ­¥åç”µè„‘å›æ»š

```
1. æ‰‹æœºæ‰“å¼€ (çŠ¶æ€: seq=500, å­¦ä¹ å‰)
2. æ‰‹æœºæ‹‰å– seq=500~1000 çš„å˜æ›´
   - å¾ˆå¤šæ–‡æ¡£åœ¨ revision tree ä¸­å½¢æˆå†²çª
   - æ‰‹æœºçš„ PouchDB ä¸­å­˜åœ¨å¤§é‡ _conflicts
3. æ‰‹æœºç¼–è¾‘ note.md
   - è¯»å–çš„å¯èƒ½æ˜¯ winning revision (å‡è®¾æ˜¯æœ€æ–°çš„)
   - ä½†æœ¬åœ°è¿˜æœ‰å†²çªçš„æ—§ revision
4. æ‰‹æœºä¿å­˜å¹¶æ¨é€
   - æ¨é€æ—¶å¯èƒ½åªæ¨é€äº† meta entryï¼Œchunks è¿˜åœ¨å†²çªä¸­
5. ç”µè„‘æ‰“å¼€åŒæ­¥
   - æ‹‰å–åˆ°æ‰‹æœºæ¨é€çš„"æ–°"revision
   - ä½† chunks æŒ‡å‘çš„å¯èƒ½æ˜¯æ—§çš„å†²çª revision
   - **ç»“æœï¼šmeta æ˜¯æ–°çš„ï¼Œä½† chunks æ˜¯æ—§çš„ â†’ æ–‡ä»¶å†…å®¹å›æ»š**
```

### åœºæ™¯2ï¼šå¹³æ¿åŒæ­¥åæ‰€æœ‰è®¾å¤‡å›æ»š

```
1. å¹³æ¿æ‰“å¼€ (çŠ¶æ€: seq=100, å¤æ—©ç‰ˆæœ¬)
2. å¹³æ¿æ‹‰å– seq=100~1000 çš„æµ·é‡å˜æ›´
   - Revision tree æå…¶å¤æ‚
   - å¤§é‡æ–‡æ¡£äº§ç”Ÿå¤šå±‚å†²çª
3. å¹³æ¿çš„å†²çªè§£å†³å™¨è¿è¡Œ
   - å› ä¸ºå¹³æ¿æœ¬åœ°æœ‰å¾ˆå¤šæ—§æ–‡æ¡£
   - è¿™äº›æ—§æ–‡æ¡£çš„ mtime å¯èƒ½å› ä¸º ZIP è§£å‹ç­‰æ“ä½œè¢«æ›´æ–°
   - **å†²çªè§£å†³å™¨é€‰æ‹©äº† mtime æ›´æ–°çš„æ—§ç‰ˆæœ¬**
4. å¹³æ¿æ¨é€"è§£å†³"åçš„æ–‡æ¡£
   - æ¨é€çš„ revision number æ›´é«˜ï¼ˆå› ä¸ºç»è¿‡å†²çªè§£å†³ï¼‰
   - ä½†å†…å®¹æ˜¯æ—§çš„
5. æœåŠ¡å™¨æ¥å—å¹³æ¿æ¨é€çš„ revision
   - å› ä¸º revision number æ›´é«˜
   - æˆä¸ºæ–°çš„ winning revision
6. å…¶ä»–è®¾å¤‡åŒæ­¥
   - æ‹‰å–åˆ°å¹³æ¿æ¨é€çš„"é«˜ revision number"æ–‡æ¡£
   - **æ‰€æœ‰è®¾å¤‡å›æ»šåˆ°å¤æ—©ç‰ˆæœ¬**
```

## è§£å†³æ–¹æ¡ˆå»ºè®®

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç´§æ€¥ä¿®å¤ï¼‰

#### 1. æ·»åŠ "è®¾å¤‡è¿‡æ—¶"æ£€æµ‹

```typescript
// æ–°å¢: DeviceObsoleteChecker.ts
export class DeviceObsoleteChecker {
    /**
     * æ£€æµ‹è®¾å¤‡æ˜¯å¦è¿‡äºé™ˆæ—§ï¼Œéœ€è¦ Fetch from Server
     */
    async checkIfDeviceObsolete(
        localDB: PouchDB.Database,
        remoteDB: PouchDB.Database
    ): Promise<{ obsolete: boolean; reason: string }> {
        const localInfo = await localDB.info();
        const remoteInfo = await remoteDB.info();
        
        const localSeq = Number(String(localInfo.update_seq).split('-')[0]);
        const remoteSeq = Number(String(remoteInfo.update_seq).split('-')[0]);
        
        // å¦‚æœæœ¬åœ°è½åè¶…è¿‡ 1000 ä¸ª sequence
        const seqGap = remoteSeq - localSeq;
        if (seqGap > 1000) {
            return {
                obsolete: true,
                reason: `Device is ${seqGap} sequences behind server. Please use 'Fetch from Server'.`
            };
        }
        
        // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰å¤§é‡å†²çª
        const conflicts = await this.getConflictCount(localDB);
        if (conflicts > 50) {
            return {
                obsolete: true,
                reason: `Device has ${conflicts} conflicts. Please use 'Fetch from Server'.`
            };
        }
        
        return { obsolete: false, reason: "" };
    }
    
    private async getConflictCount(db: PouchDB.Database): Promise<number> {
        const result = await db.allDocs({
            include_docs: false,
            conflicts: true
        });
        
        return result.rows.filter(row => 
            row.value && 'conflicts' in row.value
        ).length;
    }
}
```

#### 2. åœ¨ startSync å‰æ£€æµ‹è®¾å¤‡çŠ¶æ€

```typescript
// FridaySyncCore.ts - startSync ä¿®æ”¹
async startSync(continuous: boolean = true, options?: SyncOptions): Promise<boolean> {
    if (!this._replicator) {
        this.setStatus("ERRORED", "Replicator not initialized");
        return false;
    }

    try {
        this.setStatus("STARTED", "Checking sync status...");

        // ========== æ–°å¢ï¼šè®¾å¤‡è¿‡æ—¶æ£€æµ‹ ==========
        const obsoleteChecker = new DeviceObsoleteChecker();
        const checkResult = await obsoleteChecker.checkIfDeviceObsolete(
            this._localDatabase.localDatabase,
            await this._replicator.getRemoteDB(this._settings)
        );
        
        if (checkResult.obsolete) {
            Logger(checkResult.reason, LOG_LEVEL_NOTICE);
            Logger(
                "Your device is significantly out of sync. Please use 'Fetch from Server' " +
                "in Settings â†’ Friday Sync to safely update your vault.",
                LOG_LEVEL_NOTICE
            );
            this.setStatus("ERRORED", "Device obsolete - Fetch from Server required");
            return false;
        }

        // ========== ç»§ç»­åŸæœ‰çš„åŒæ­¥æµç¨‹ ==========
        // ...
    }
}
```

#### 3. æ”¹è¿›å†²çªè§£å†³ç­–ç•¥

```typescript
// HiddenFileSync.ts - resolveByNewerEntry ä¿®æ”¹
private async resolveByNewerEntry(
    id: DocumentID,
    path: FilePathWithPrefix,
    currentDoc: MetaEntry,
    currentRev: string,
    conflictedRev: string
): Promise<void> {
    const localDB = this.core.localDatabase;
    if (!localDB) return;
    
    try {
        const conflictedDoc = await localDB.getRaw<MetaEntry>(id, { rev: conflictedRev });
        
        // ========== æ–°å¢ï¼šå¤šç»´åº¦æ¯”è¾ƒ ==========
        
        // 1. æ¯”è¾ƒ revision number (revision ä»£æ•°)
        const currentRevNum = Number(currentRev.split('-')[0]);
        const conflictedRevNum = Number(conflictedRev.split('-')[0]);
        
        // 2. æ¯”è¾ƒ mtime
        const mtimeCurrent = getComparingMTime(currentDoc, true);
        const mtimeConflicted = getComparingMTime(conflictedDoc, true);
        
        // 3. æ¯”è¾ƒæ–‡æ¡£å¤§å° (ä½œä¸º tie-breaker)
        const sizeCurrent = currentDoc.size || 0;
        const sizeConflicted = conflictedDoc.size || 0;
        
        // ========== å†³ç­–é€»è¾‘ ==========
        let deleteRev: string;
        
        // ä¼˜å…ˆï¼šå¦‚æœ revision number å·®è·å¾ˆå¤§ï¼ˆ>10ä»£ï¼‰ï¼Œä¿¡ä»» revision number
        if (Math.abs(currentRevNum - conflictedRevNum) > 10) {
            deleteRev = currentRevNum < conflictedRevNum ? currentRev : conflictedRev;
            Logger(
                `[HiddenFileSync] Conflict resolved by revision number: ` +
                `keeping ${deleteRev === currentRev ? 'conflicted' : 'current'} (rev diff: ${Math.abs(currentRevNum - conflictedRevNum)})`,
                LOG_LEVEL_INFO
            );
        }
        // æ¬¡ä¼˜ï¼šæ¯”è¾ƒ mtimeï¼ˆä½†è¦è­¦æƒ•ï¼‰
        else if (Math.abs(mtimeCurrent - mtimeConflicted) > 60000) { // è¶…è¿‡1åˆ†é’Ÿå·®å¼‚
            deleteRev = mtimeCurrent < mtimeConflicted ? currentRev : conflictedRev;
            Logger(
                `[HiddenFileSync] Conflict resolved by mtime: ` +
                `keeping ${deleteRev === currentRev ? 'conflicted' : 'current'}`,
                LOG_LEVEL_INFO
            );
        }
        // æœ€åï¼šå¦‚æœä»¥ä¸Šéƒ½ä¸æ˜æ˜¾ï¼Œä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬ï¼Œè®©ç”¨æˆ·å†³å®š
        else {
            Logger(
                `[HiddenFileSync] Conflict cannot be auto-resolved: ${path}. ` +
                `Current: rev=${currentRevNum}, mtime=${mtimeCurrent}, size=${sizeCurrent}. ` +
                `Conflicted: rev=${conflictedRevNum}, mtime=${mtimeConflicted}, size=${sizeConflicted}. ` +
                `Please manually resolve.`,
                LOG_LEVEL_NOTICE
            );
            
            // ä¸åˆ é™¤ä»»ä½• revisionï¼Œæ ‡è®°ä¸ºéœ€è¦æ‰‹åŠ¨è§£å†³
            await this.markForManualResolution(id, path, currentRev, conflictedRev);
            return;
        }
        
        await localDB.removeRevision(id, deleteRev);
        
        // ... ç»§ç»­åŸæœ‰çš„åç»­å¤„ç† ...
    } catch (ex) {
        Logger(`[HiddenFileSync] resolveByNewerEntry failed: ${path}`, LOG_LEVEL_VERBOSE);
        Logger(ex, LOG_LEVEL_VERBOSE);
    }
}

/**
 * æ ‡è®°å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³
 */
private async markForManualResolution(
    id: DocumentID,
    path: FilePathWithPrefix,
    rev1: string,
    rev2: string
): Promise<void> {
    // å­˜å‚¨åˆ°ä¸“é—¨çš„å†²çªé˜Ÿåˆ—
    const conflictStore = this.core.services.database.openSimpleStore<{
        path: string;
        revisions: string[];
        timestamp: number;
    }>("friday-sync-conflicts");
    
    await conflictStore.set(id, {
        path: stripAllPrefixes(path) as string,
        revisions: [rev1, rev2],
        timestamp: Date.now()
    });
    
    // æ˜¾ç¤ºé€šçŸ¥
    Logger(
        `Conflict detected in "${stripAllPrefixes(path)}". ` +
        `Please check Settings â†’ Friday Sync â†’ Resolve Conflicts.`,
        LOG_LEVEL_NOTICE
    );
}
```

### ä¸­æœŸæ–¹æ¡ˆï¼ˆæ¶æ„æ”¹è¿›ï¼‰

#### 1. å®ç°"æ•°æ®åº“ä»£"ï¼ˆGenerationï¼‰æœºåˆ¶

```typescript
// ç±»ä¼¼ Git çš„ generation number
interface DatabaseGeneration {
    generation: number;      // å…¨å±€ä»£æ•°
    last_sync_time: number; // æœ€ååŒæ­¥æ—¶é—´
    device_id: string;       // è®¾å¤‡ ID
}

// æ¯æ¬¡ rebuild remote æˆ– fetch from server æ—¶å¢åŠ  generation
// è®¾å¤‡åŒæ­¥æ—¶æ£€æŸ¥ generation å·®è·
```

#### 2. å®ç°"å®‰å…¨æ—¶é—´çª—å£"æœºåˆ¶

```typescript
// åŒæ­¥å®Œæˆå‰é”å®šæ–‡ä»¶ç¼–è¾‘
class SyncLockManager {
    private lockedPaths: Set<string> = new Set();
    
    lockPath(path: string): void {
        this.lockedPaths.add(path);
        // åœ¨ Obsidian UI ä¸­æ˜¾ç¤º"æ­£åœ¨åŒæ­¥"çš„æŒ‡ç¤ºå™¨
    }
    
    unlockPath(path: string): void {
        this.lockedPaths.delete(path);
    }
    
    isLocked(path: string): boolean {
        return this.lockedPaths.has(path);
    }
}

// åœ¨æ–‡ä»¶ç¼–è¾‘å‰æ£€æŸ¥
vault.on('modify', (file) => {
    if (syncLockManager.isLocked(file.path)) {
        // å»¶è¿Ÿä¿å­˜ï¼Œç­‰å¾…åŒæ­¥å®Œæˆ
        scheduleTask(`save-after-sync-${file.path}`, 1000, () => {
            // é‡æ–°æ£€æŸ¥å¹¶ä¿å­˜
        });
    }
});
```

### é•¿æœŸæ–¹æ¡ˆï¼ˆé‡æ„ï¼‰

#### 1. å‚è€ƒ Git çš„ Three-Way Merge

```typescript
// å®ç°ç±»ä¼¼ Git çš„ merge base æŸ¥æ‰¾
class ThreeWayMerge {
    async findCommonAncestor(
        rev1: string,
        rev2: string,
        db: PouchDB.Database
    ): Promise<string | null> {
        // éå† revision treeï¼Œæ‰¾åˆ°æœ€è¿‘çš„å…±åŒç¥–å…ˆ
    }
    
    async threeWayMerge(
        base: MetaEntry,
        local: MetaEntry,
        remote: MetaEntry
    ): Promise<MetaEntry> {
        // åŸºäºå…±åŒç¥–å…ˆçš„ä¸‰æ–¹åˆå¹¶
    }
}
```

#### 2. å®ç° CRDTï¼ˆConflict-free Replicated Data Typeï¼‰

```typescript
// å¯¹äºæŸäº›ç±»å‹çš„æ–‡æ¡£ï¼ˆå¦‚ JSON é…ç½®ï¼‰ï¼Œä½¿ç”¨ CRDT
// è¿™æ ·å¯ä»¥å®ç°è‡ªåŠ¨æ— å†²çªåˆå¹¶
```

## ä¸´æ—¶åº”å¯¹æªæ–½ï¼ˆç”¨æˆ·æŒ‡å—ï¼‰

### å¯¹äºç”¨æˆ·çš„å»ºè®®ï¼š

1. **è®¾å¤‡é•¿æœŸæœªç”¨åçš„æ­£ç¡®æ“ä½œï¼š**
   ```
   âŒ é”™è¯¯ï¼šç›´æ¥æ‰“å¼€ Obsidian å¹¶å¯ç”¨åŒæ­¥
   âœ… æ­£ç¡®ï¼š
      a. æ‰“å¼€ Obsidianï¼Œä½†å…ˆç¦ç”¨ Friday Sync
      b. è¿›å…¥ Settings â†’ Friday Sync
      c. ç‚¹å‡» "Fetch from Server"
      d. ç­‰å¾…å®Œå…¨ä¸‹è½½å®Œæˆ
      e. å†å¯ç”¨ LiveSync
   ```

2. **å‘ç°æ•°æ®å›æ»šåçš„æ¢å¤ï¼š**
   ```
   âœ… ç«‹å³åœæ­¢æ‰€æœ‰è®¾å¤‡çš„åŒæ­¥
   âœ… åœ¨ Settings â†’ Friday Sync ä¸­æ¢å¤åˆ°å›æ»šå‰çš„å¿«ç…§
   âœ… è”ç³»æŠ€æœ¯æ”¯æŒ
   ```

3. **é¢„é˜²æªæ–½ï¼š**
   ```
   âœ… æ‰€æœ‰è®¾å¤‡è‡³å°‘æ¯å‘¨åŒæ­¥ä¸€æ¬¡
   âœ… å¯ç”¨è‡ªåŠ¨å¿«ç…§ï¼ˆæ¯å°æ—¶ï¼‰
   âœ… é‡è¦ç¼–è¾‘å‰å…ˆç¡®è®¤åŒæ­¥å®Œæˆ
   ```

## æµ‹è¯•å»ºè®®

### å¤ç°æµ‹è¯•ç”¨ä¾‹ï¼š

```typescript
describe('Long Offline Device Sync', () => {
    it('should detect obsolete device', async () => {
        // 1. åˆ›å»ºè®¾å¤‡ Aï¼ŒåŒæ­¥ 1000 ä¸ªæ–‡æ¡£
        // 2. è®¾å¤‡ A ç¦»çº¿
        // 3. è®¾å¤‡ B ä¿®æ”¹ 500 ä¸ªæ–‡æ¡£
        // 4. è®¾å¤‡ A ä¸Šçº¿
        // 5. æ–­è¨€ï¼šåº”è¯¥æç¤º "Fetch from Server"
    });
    
    it('should not rollback data', async () => {
        // 1. è®¾å¤‡ Aï¼ˆæœ€æ–°ï¼‰ã€Bï¼ˆæ¬¡æ–°ï¼‰ã€Cï¼ˆå¤æ—©ï¼‰
        // 2. æŒ‰é¡ºåºåŒæ­¥ï¼šB -> A -> C
        // 3. æ–­è¨€ï¼šæ•°æ®ä¸åº”è¯¥å›æ»š
    });
});
```

## ä¼˜å…ˆçº§è¯„ä¼°

| æ–¹æ¡ˆ | ä¼˜å…ˆçº§ | å®ç°éš¾åº¦ | å½±å“èŒƒå›´ | é¢„ä¼°æ—¶é—´ |
|-----|--------|---------|---------|---------|
| è®¾å¤‡è¿‡æ—¶æ£€æµ‹ | ğŸ”´ P0 | ä½ | å° | 2å¤© |
| æ”¹è¿›å†²çªè§£å†³ | ğŸ”´ P0 | ä¸­ | ä¸­ | 5å¤© |
| å®‰å…¨æ—¶é—´çª—å£ | ğŸŸ¡ P1 | ä¸­ | ä¸­ | 1å‘¨ |
| æ•°æ®åº“ä»£æœºåˆ¶ | ğŸŸ¡ P1 | é«˜ | å¤§ | 2å‘¨ |
| Three-Way Merge | ğŸŸ¢ P2 | å¾ˆé«˜ | å¤§ | 1ä¸ªæœˆ |

## å‚è€ƒèµ„æ–™

- CouchDB Replication Protocol: https://docs.couchdb.org/en/stable/replication/protocol.html
- PouchDB Conflicts: https://pouchdb.com/guides/conflicts.html
- Obsidian LiveSync æºç : `livesync/src/modules/core/ModuleReplicator.ts`
- MVCC åŸç†: https://en.wikipedia.org/wiki/Multiversion_concurrency_control

