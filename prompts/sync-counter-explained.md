# LiveSync/Friday 同步计数器详解

## 问题

你观察到的现象：
- 删除文件：上传 +1，其他设备下载 +1 ✅
- 新增文件：上传 +2，其他设备下载 +1 ❓

## 答案

**这是正常的！** 上传 +2 是因为 LiveSync 将文件分成了 **2 个文档**：

1. **元数据文档 (Metadata)** - 1 个
2. **内容块文档 (Chunk/Leaf)** - 1 个或多个

## LiveSync 的文档结构

### 文档类型

在 PouchDB/CouchDB 中，LiveSync 使用以下文档类型：

```typescript
export const EntryTypes = {
    NOTE_PLAIN: "plain",      // 文本文件的元数据
    NOTE_BINARY: "newnote",   // 二进制文件的元数据
    CHUNK: "leaf",            // 文件内容块
    // ... 其他类型
}
```

### 文件存储结构

**每个文件在数据库中存储为 2+ 个文档**：

```
文件: "MDFriday Notes.md" (2KB)
    ↓
PouchDB 存储:
    ├─ 元数据文档 (type: "plain")
    │    _id: "MDFriday Notes.md"
    │    path: "MDFriday Notes.md"
    │    size: 2048
    │    mtime: 1706543210000
    │    children: ["leaf-abc123"]  ← 指向内容块
    │    type: "plain"
    │
    └─ 内容块文档 (type: "leaf")
         _id: "leaf-abc123"
         data: "文件的实际内容..."
         type: "leaf"
```

## 为什么要分成两个文档？

### 1. **性能优化** - 按需加载

```typescript
// 只拉取元数据（不包含内容块）
const selectorOnDemandPull = { 
    selector: { type: { $ne: "leaf" } }  // 排除 leaf 类型
};
```

- **快速同步**：先同步元数据，知道有哪些文件
- **按需下载**：只在打开文件时才下载内容块
- **节省流量**：不需要的文件不下载内容

### 2. **大文件支持** - 分块存储

对于大文件，会分成多个 chunk：

```
大文件: "video.mp4" (10MB)
    ↓
PouchDB 存储:
    ├─ 元数据文档 (1 个)
    │    children: ["leaf-001", "leaf-002", "leaf-003", ...]
    │
    ├─ 内容块 1 (type: "leaf")
    │    _id: "leaf-001"
    │    data: [chunk 1 data]
    │
    ├─ 内容块 2 (type: "leaf")
    │    _id: "leaf-002"
    │    data: [chunk 2 data]
    │
    └─ ...更多块
```

**好处**：
- CouchDB 单个文档有大小限制
- 增量同步：只传输变化的块
- 断点续传：块传输失败可以重试

## 计数逻辑详解

### 代码位置

```typescript
// src/sync/core/replication/couchdb/LiveSyncReplicator.ts:360-372
async replicationChangeDetected(e: PouchDB.Replication.SyncResult<EntryDoc>) {
    if (e.direction == "pull") {
        // 下载：处理接收到的文档
        await this.env.services.replication.parseSynchroniseResult(e.change.docs);
        this.docArrived += e.change.docs.length;  // ← 计数
    } else {
        // 上传：记录发送的文档
        this.docSent += e.change.docs.length;      // ← 计数
    }
}
```

**关键**：`e.change.docs.length` 是 PouchDB 报告的**文档数量**，不是文件数量！

### 新增文件的计数

**场景：设备 A 新增 `note.md`**

```
设备 A (上传):
    ┌─────────────────────────────────────┐
    │ 1. 创建元数据文档                      │
    │    _id: "note.md"                    │
    │    type: "plain"                     │
    │    → docSent +1                      │
    ├─────────────────────────────────────┤
    │ 2. 创建内容块文档                      │
    │    _id: "leaf-xyz789"                │
    │    type: "leaf"                      │
    │    → docSent +1                      │
    └─────────────────────────────────────┘
    总计: ↑ 2

设备 B (下载):
    ┌─────────────────────────────────────┐
    │ 接收到 1 个元数据文档                   │
    │    _id: "note.md"                    │
    │    → docArrived +1                   │
    └─────────────────────────────────────┘
    总计: ↓ 1
```

**为什么 B 只显示 +1？**

因为 LiveSync 的设置启用了 **"按需拉取 (On-Demand Pull)"**：

```typescript
// src/sync/core/replication/couchdb/LiveSyncReplicator.ts:68
const selectorOnDemandPull = { 
    selector: { type: { $ne: "leaf" } }  // 不拉取 leaf 类型
};

// 第 873-875 行：使用 on-demand pull selector
setting.readChunksOnline ? selectorOnDemandPull : {}
```

**流程**：
1. ✅ B 接收元数据文档（知道有新文件）
2. ❌ B **不接收** 内容块（按需加载）
3. 👤 用户在 B 上打开文件时
4. ✅ B 才下载对应的内容块

### 删除文件的计数

**场景：设备 A 删除 `note.md`**

```
设备 A (上传):
    ┌─────────────────────────────────────┐
    │ 1. 标记元数据文档为删除                 │
    │    _id: "note.md"                    │
    │    _deleted: true                    │
    │    → docSent +1                      │
    └─────────────────────────────────────┘
    总计: ↑ 1
    
    注意：内容块不需要单独标记删除，
          CouchDB 会自动清理（或保留用于冲突解决）

设备 B (下载):
    ┌─────────────────────────────────────┐
    │ 接收到 1 个删除标记                    │
    │    _id: "note.md"                    │
    │    _deleted: true                    │
    │    → docArrived +1                   │
    └─────────────────────────────────────┘
    总计: ↓ 1
```

### 修改文件的计数

**场景：设备 A 修改 `note.md`（内容变化）**

```
设备 A (上传):
    ┌─────────────────────────────────────┐
    │ 1. 更新元数据文档                      │
    │    _id: "note.md"                    │
    │    mtime: [新时间]                    │
    │    children: ["leaf-new456"]         │
    │    → docSent +1                      │
    ├─────────────────────────────────────┤
    │ 2. 创建新的内容块文档                   │
    │    _id: "leaf-new456"                │
    │    data: [新内容]                     │
    │    → docSent +1                      │
    └─────────────────────────────────────┘
    总计: ↑ 2

设备 B (下载):
    ┌─────────────────────────────────────┐
    │ 接收到 1 个元数据更新                   │
    │    → docArrived +1                   │
    └─────────────────────────────────────┘
    总计: ↓ 1
    
    （内容块按需下载，打开文件时才拉取）
```

## 状态栏显示

```
Sync: ⚡ ↑ 2 ↓ 1 (正常同步中)
       │  │  │
       │  │  └─ 下载了 1 个文档（元数据）
       │  └──── 上传了 2 个文档（元数据 + 内容块）
       └─────── 网络活动指示器
```

## 完整示例：三设备场景

### 场景：设备 A 新增文件 `test.md`

```
┌─────────────────────────────────────────────────────────────┐
│ 设备 A (新增)                                                 │
│ ┌─────────────────────────────────────┐                     │
│ │ test.md                              │                     │
│ │ 内容: "Hello World"                   │                     │
│ └─────────────────────────────────────┘                     │
│                  ↓                                           │
│ 上传到 CouchDB:                                               │
│  ├─ Doc 1: test.md (type: plain)                            │
│  └─ Doc 2: leaf-abc (type: leaf, data: "Hello World")      │
│                                                              │
│ 状态栏: ↑ 2                                                  │
└─────────────────────────────────────────────────────────────┘
                      ↓ (同步到 CouchDB)
┌─────────────────────────────────────────────────────────────┐
│ CouchDB 服务器                                                │
│ ┌─────────────────────────────────────┐                     │
│ │ 数据库中的文档:                        │                     │
│ │ • test.md (plain)                    │                     │
│ │ • leaf-abc (leaf)                    │                     │
│ └─────────────────────────────────────┘                     │
└─────────────────────────────────────────────────────────────┘
        ↓                           ↓
┌──────────────────┐        ┌──────────────────┐
│ 设备 B (PC)       │        │ 设备 C (Mobile)   │
│ 下载:             │        │ 下载:             │
│ • test.md (元数据) │        │ • test.md (元数据) │
│                  │        │                  │
│ 状态栏: ↓ 1       │        │ 状态栏: ↓ 1       │
│                  │        │                  │
│ 内容块不下载！     │        │ 内容块不下载！     │
│ （打开文件时下载）  │        │ （打开文件时下载）  │
└──────────────────┘        └──────────────────┘
```

### 当设备 B 打开 `test.md` 时：

```
┌──────────────────┐
│ 设备 B            │
│ 1. 打开 test.md   │
│    ↓              │
│ 2. 检测到缺失内容块 │
│    children: ["leaf-abc"]  ← 从元数据读取
│    ↓              │
│ 3. 从 CouchDB 拉取│
│    leaf-abc       │
│    ↓              │
│ 4. 显示内容        │
│    "Hello World"  │
│                  │
│ 这时可能会有额外的 │
│ ↓ +1 显示         │
└──────────────────┘
```

## 为什么这样设计？

### 优点

1. **流量节省** 
   - 只同步文件列表（元数据），不同步所有内容
   - 移动端尤其受益（流量有限）

2. **速度快**
   - 初始同步很快（只有元数据）
   - 立即知道有哪些文件更新

3. **灵活性**
   - 可以选择不同的同步策略
   - 支持大文件（分块传输）

4. **冲突处理**
   - 元数据和内容分离
   - 更容易检测和解决冲突

### 设置选项

在 LiveSync 设置中可以选择：

- ✅ **On-Demand (按需)** - 默认
  - 只同步元数据
  - 打开文件时下载内容
  - **推荐移动端使用**

- ❌ **All (全部)**
  - 同步元数据和所有内容块
  - 所有文件立即可用
  - **推荐 PC 端使用（Wi-Fi 环境）**

## 总结

| 操作 | 设备 A 上传 | 设备 B/C 下载 (On-Demand) | 说明 |
|------|-----------|------------------------|------|
| 新增文件 | ↑ 2 | ↓ 1 | 元数据 + 内容块 vs 只有元数据 |
| 删除文件 | ↑ 1 | ↓ 1 | 只有元数据删除标记 |
| 修改文件 | ↑ 2 | ↓ 1 | 元数据 + 新内容块 vs 只有元数据 |
| 重命名文件 | ↑ 2 | ↓ 2 | 删除旧 + 创建新 |

**记住**：
- 📊 计数器显示的是 **文档数量**，不是文件数量
- 📦 每个文件 = 1 个元数据文档 + N 个内容块文档
- 🚀 On-Demand 模式只同步元数据，内容块按需下载
- 💾 这是 LiveSync 的核心设计，用于提高性能和节省流量

**所以你看到的 "新增文件 A 上传 +2，B/C 下载 +1" 是完全正常的！** ✅

