# æœ€ç»ˆåˆ†ææŠ¥å‘Šä¸è§£å†³æ–¹æ¡ˆ

## æ ¸å¿ƒå‘ç°

ç»è¿‡è¯¦ç»†å¯¹æ¯” livesync æºç ï¼Œæˆ‘ä»¬çš„å®ç°**å®Œå…¨ç›¸åŒ**ï¼š

1. âœ… `isChunkDoc` å‡½æ•° - å®Œå…¨ç›¸åŒ
2. âœ… `selectorOnDemandPull` - å®Œå…¨ç›¸åŒ  
3. âœ… `ChunkFetcher.write` ä½¿ç”¨ `force: true` - å®Œå…¨ç›¸åŒ
4. âœ… `replicationFilter` - å®Œå…¨ç›¸åŒ
5. âœ… é»˜è®¤é…ç½® - å®Œå…¨ç›¸åŒ

## ğŸ¯ çœŸæ­£çš„é—®é¢˜

### ä»æ—¥å¿—åˆ†æ

```javascript
[ChunkFetcher] Fetch result: {success: true, fetchedCount: 100, requestedCount: 100}
[ChunkFetcher] Chunks stored successfully: {stored: 100, written: 0, cached: 0, duplicated: 0}
```

**å…³é”®**ï¼š`written: 0, cached: 0, duplicated: 0`

è¿™æ„å‘³ç€ï¼š
- ä¸æ˜¯ç¼“å­˜è·³è¿‡ï¼ˆ`cached: 0`ï¼‰
- ä¸æ˜¯å†²çªæ£€æµ‹ï¼ˆ`duplicated: 0`ï¼‰
- è€Œæ˜¯ PouchDB çš„ `bulkDocs` **è¿”å›æˆåŠŸä½†å®é™…æ²¡æœ‰å†™å…¥**

### PouchDB `new_edits: false` çš„è¡Œä¸º

æ ¹æ® PouchDB æ–‡æ¡£ï¼š

```typescript
await db.bulkDocs(docs, { new_edits: false })
```

å½“ `new_edits: false` æ—¶ï¼š
- PouchDB ä½¿ç”¨æ–‡æ¡£çš„åŸå§‹ `_rev`
- å¦‚æœæœ¬åœ°å·²å­˜åœ¨ç›¸åŒ `_id` å’Œ `_rev` çš„æ–‡æ¡£ï¼Œ**ä¸ä¼šæ›´æ–°ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™**
- è¿”å›ç»“æœæ˜¾ç¤ºæˆåŠŸï¼Œä½†å®é™…æ²¡æœ‰ä¿®æ”¹

**è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆ `written: 0` ä½†æ²¡æœ‰æŠ›å‡ºé”™è¯¯ï¼**

### ä¸ºä»€ä¹ˆä¼šæœ‰ç›¸åŒçš„ `_rev`ï¼Ÿ

å½“ `readChunksOnline=true` æ—¶ï¼ŒCouchDB selector **åªé˜»æ­¢ `data` å­—æ®µçš„ä¼ è¾“ï¼Œä½†ä¼šä¼ è¾“å…ƒæ•°æ®**ï¼ˆ`_id`, `_rev`, `type`ï¼‰ã€‚

æ‰€ä»¥è®¾å¤‡ B çš„æœ¬åœ°æ•°æ®åº“ä¸­æœ‰ï¼š
```javascript
{
  _id: "h:abc123",
  _rev: "1-xyz",
  type: "leaf",
  // data å­—æ®µç¼ºå¤±æˆ–ä¸ºç©º
}
```

å½“ ChunkFetcher ä»è¿œç¨‹æ‹‰å–å®Œæ•´ chunk æ—¶ï¼š
```javascript
{
  _id: "h:abc123",
  _rev: "1-xyz",  // â† ç›¸åŒçš„ _revï¼
  type: "leaf",
  data: "å®Œæ•´çš„æ•°æ®..."
}
```

ä½¿ç”¨ `new_edits: false` ä¿å­˜æ—¶ï¼ŒPouchDB å‘ç° `_id` å’Œ `_rev` ç›¸åŒï¼Œ**è®¤ä¸ºæ˜¯é‡å¤æ“ä½œï¼Œä¸åšä»»ä½•ä¿®æ”¹**ã€‚

## ğŸ¤” ä¸ºä»€ä¹ˆ livesync èƒ½å·¥ä½œï¼Ÿ

**å‡è®¾ 1ï¼šlivesync çš„ selector çœŸçš„é˜»æ­¢äº†æ‰€æœ‰ chunk æ–‡æ¡£**

å¯èƒ½ livesync ä½¿ç”¨çš„ CouchDB/PouchDB ç‰ˆæœ¬ä¸­ï¼Œselector èƒ½å®Œå…¨é˜»æ­¢ chunk æ–‡æ¡£çš„åŒæ­¥ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ï¼‰ã€‚

**å‡è®¾ 2ï¼šlivesync æœ‰å…¶ä»–æœºåˆ¶å¤„ç†è¿™ä¸ªé—®é¢˜**

å¯èƒ½åœ¨æˆ‘ä»¬æ²¡æœ‰å¯¹æ¯”åˆ°çš„åœ°æ–¹ï¼ˆå¦‚ Obsidian ç‰¹å®šçš„ä»£ç ï¼Œè€Œä¸æ˜¯ commonlibï¼‰ã€‚

**å‡è®¾ 3ï¼šlivesync ç”¨æˆ·å¾ˆå°‘é‡åˆ°è¿™ä¸ªé—®é¢˜**

å¯èƒ½è¿™æ˜¯ä¸€ä¸ªç½•è§çš„è¾¹ç¼˜æƒ…å†µï¼Œæˆ–è€… livesync ç”¨æˆ·é€šå¸¸ä¸å¯ç”¨ `readChunksOnline`ã€‚

## ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼ˆä¸ä¿®æ”¹ core ä»£ç ï¼‰

### æ–¹æ¡ˆ Aï¼šåœ¨é core ä»£ç ä¸­æ‹¦æˆªå’Œä¿®å¤ â­â­â­ æ¨è

åœ¨ `FridaySyncCore.ts` æˆ– `FridayServiceHub.ts` ä¸­æ·»åŠ é€»è¾‘ï¼Œå®šæœŸæ¸…ç†ç©ºå£³ chunksã€‚

**ä½ç½®**ï¼š`src/sync/FridaySyncCore.ts`

**å®ç°**ï¼šæ·»åŠ ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥å¹¶ä¿®å¤ç©ºå£³ chunksï¼š

```typescript
// src/sync/FridaySyncCore.ts

/**
 * æ¸…ç†ç©ºå£³ chunksï¼ˆä»…æœ‰å…ƒæ•°æ®ä½†æ²¡æœ‰ data çš„ chunksï¼‰
 * è¿™äº›ç©ºå£³ chunks ä¼šé˜»æ­¢ ChunkFetcher ä¿å­˜å®Œæ•´çš„ chunks
 */
private async cleanupShellChunks(): Promise<void> {
    if (!this._localDatabase) return;
    
    try {
        const db = this._localDatabase.localDatabase;
        
        // æŸ¥æ‰¾æ‰€æœ‰ chunk æ–‡æ¡£
        const result = await db.allDocs({
            startkey: 'h:',
            endkey: 'h:\uffff',
            include_docs: true,
            limit: 1000,  // æ¯æ¬¡å¤„ç† 1000 ä¸ª
        });
        
        const shellChunks = result.rows
            .filter(row => {
                if (!('doc' in row) || !row.doc) return false;
                const doc = row.doc as any;
                // æ‰¾åˆ°æ²¡æœ‰ data æˆ– data ä¸ºç©ºçš„ chunk
                return doc.type === 'leaf' && (!doc.data || doc.data.length === 0);
            })
            .map(row => ({
                ...(row as any).doc,
                _deleted: true,
            }));
        
        if (shellChunks.length > 0) {
            console.log(`[Friday Sync] Found ${shellChunks.length} shell chunks, deleting...`);
            await db.bulkDocs(shellChunks);
            console.log(`[Friday Sync] Shell chunks cleaned up successfully`);
        }
    } catch (error) {
        console.warn('[Friday Sync] Failed to cleanup shell chunks:', error);
    }
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
1. åœ¨åŒæ­¥å¼€å§‹å‰
2. åœ¨æ•°æ®åº“åˆå§‹åŒ–å
3. å¯é€‰ï¼šå®šæœŸåå°ä»»åŠ¡

### æ–¹æ¡ˆ Bï¼šåœ¨ ChunkFetcher äº‹ä»¶ç›‘å¬å™¨ä¸­å¤„ç†

åœ¨ `FridaySyncCore.ts` ä¸­ç›‘å¬ `EVENT_MISSING_CHUNKS`ï¼Œåœ¨ ChunkFetcher æ‹‰å–å‰å…ˆæ¸…ç†å¯¹åº”çš„ç©ºå£³ chunksã€‚

**ä½ç½®**ï¼š`src/sync/FridaySyncCore.ts`

**å®ç°**ï¼š

```typescript
// åœ¨åˆå§‹åŒ–æ—¶æ·»åŠ ç›‘å¬å™¨
this._managers.chunkManager.addListener('missingChunks', async (chunkIds: string[]) => {
    // åœ¨ ChunkFetcher æ‹‰å–å‰ï¼Œåˆ é™¤è¿™äº› chunk ID çš„ç©ºå£³æ–‡æ¡£
    await this.deleteShellChunks(chunkIds);
});

private async deleteShellChunks(chunkIds: string[]): Promise<void> {
    if (!this._localDatabase) return;
    
    try {
        const db = this._localDatabase.localDatabase;
        const docs = await db.allDocs({
            keys: chunkIds,
            include_docs: true,
        });
        
        const toDelete = docs.rows
            .filter(row => {
                if (!('doc' in row) || !row.doc) return false;
                const doc = row.doc as any;
                return doc.type === 'leaf' && (!doc.data || doc.data.length === 0);
            })
            .map(row => ({
                ...(row as any).doc,
                _deleted: true,
            }));
        
        if (toDelete.length > 0) {
            await db.bulkDocs(toDelete);
            console.log(`[Friday Sync] Deleted ${toDelete.length} shell chunks before fetching`);
        }
    } catch (error) {
        console.warn('[Friday Sync] Failed to delete shell chunks:', error);
    }
}
```

### æ–¹æ¡ˆ Cï¼šä¿®æ”¹ replication é…ç½®ï¼ˆæœ€ä¼˜é›…ä½†å¯èƒ½ä¸å¯è¡Œï¼‰

å°è¯•é…ç½® PouchDB çš„ replicationï¼Œä½¿å…¶çœŸæ­£è·³è¿‡ chunk æ–‡æ¡£ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ï¼‰ã€‚

**ä½ç½®**ï¼š`src/sync/FridaySyncCore.ts` æˆ– replicator ç›¸å…³ä»£ç 

**å¯èƒ½çš„å®ç°**ï¼š

```typescript
// å°è¯•æ·»åŠ æ›´ä¸¥æ ¼çš„ filter
const selectorOnDemandPull = { 
    selector: { 
        $and: [
            { type: { $ne: "leaf" } },
            { _id: { $not: { $regex: "^h:" } } }  // é¢å¤–æ’é™¤ä»¥ h: å¼€å¤´çš„æ–‡æ¡£
        ]
    } 
};
```

ä½†è¿™å¯èƒ½ä¸å¤Ÿï¼Œå› ä¸º CouchDB replication åè®®çš„é™åˆ¶ã€‚

### æ–¹æ¡ˆ Dï¼šåœ¨åŒæ­¥å®Œæˆåè§¦å‘ä¿®å¤

åœ¨æ¯æ¬¡åŒæ­¥å®Œæˆåï¼Œæ£€æŸ¥å¹¶ä¿®å¤æ‰€æœ‰ç©ºå£³ chunksã€‚

**ä½ç½®**ï¼š`src/sync/FridaySyncCore.ts` çš„åŒæ­¥å®Œæˆå›è°ƒ

**å®ç°**ï¼š

```typescript
// åœ¨ startSync çš„æˆåŠŸå›è°ƒä¸­
private async onSyncComplete(): Promise<void> {
    console.log('[Friday Sync] Sync completed, checking for shell chunks...');
    await this.cleanupShellChunks();
}
```

## ğŸ“‹ æ¨èå®æ–½æ–¹æ¡ˆ

### çŸ­æœŸä¿®å¤ï¼ˆç«‹å³å®æ–½ï¼‰

**ä½¿ç”¨æ–¹æ¡ˆ B**ï¼šåœ¨ ChunkFetcher æ‹‰å–å‰åˆ é™¤ç©ºå£³ chunks

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¿®æ”¹ core ä»£ç ï¼ˆlivesync æºç ï¼‰
- âœ… ç²¾ç¡®å¤„ç†ï¼šåªåˆ é™¤éœ€è¦æ‹‰å–çš„ chunks
- âœ… åŠæ—¶ï¼šåœ¨æ‹‰å–å‰ç«‹å³å¤„ç†
- âœ… ä¸å½±å“å…¶ä»–åŠŸèƒ½

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨ `FridaySyncCore.ts` æ·»åŠ  `deleteShellChunks` æ–¹æ³•
2. åœ¨æ•°æ®åº“åˆå§‹åŒ–åæ³¨å†Œç›‘å¬å™¨
3. æµ‹è¯•éªŒè¯

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2 å‘¨å†…ï¼‰

**ç»„åˆæ–¹æ¡ˆ A + B**ï¼šå®šæœŸæ¸…ç† + æŒ‰éœ€æ¸…ç†

**åŸå› **ï¼š
- æ–¹æ¡ˆ B åªå¤„ç†å®é™…è¢«è®¿é—®çš„æ–‡ä»¶
- æ–¹æ¡ˆ A å®šæœŸæ¸…ç†æ‰€æœ‰ç©ºå£³ chunksï¼Œä¿æŒæ•°æ®åº“å¥åº·

### é•¿æœŸç ”ç©¶ï¼ˆå¯é€‰ï¼‰

**è°ƒæŸ¥ä¸ºä»€ä¹ˆ livesync ä¸ä¼šäº§ç”Ÿç©ºå£³ chunks**

å¯èƒ½çš„æ–¹å‘ï¼š
1. æµ‹è¯•ä¸åŒç‰ˆæœ¬çš„ CouchDB/PouchDB
2. æ£€æŸ¥ Obsidian ç‰¹å®šçš„ livesync ä»£ç 
3. å’¨è¯¢ livesync ä½œè€…

## ğŸ§ª éªŒè¯æ–¹æ³•

### éªŒè¯ç©ºå£³ chunks å­˜åœ¨

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
const db = app.plugins.plugins['friday-sync'].syncCore._localDatabase.localDatabase;

db.allDocs({
    startkey: 'h:',
    endkey: 'h:\uffff',
    include_docs: true,
    limit: 10,
}).then(result => {
    const shellChunks = result.rows.filter(row => {
        const doc = row.doc;
        return doc && doc.type === 'leaf' && (!doc.data || doc.data.length === 0);
    });
    console.log('Shell chunks found:', shellChunks.length);
    console.log('Examples:', shellChunks.slice(0, 3));
});
```

### éªŒè¯ä¿®å¤æ•ˆæœ

1. å®æ–½æ–¹æ¡ˆ B
2. é‡ç°é—®é¢˜ï¼ˆåŒæ­¥å¤§æ–‡ä»¶ï¼‰
3. æ£€æŸ¥æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```javascript
   [Friday Sync] Deleted 108 shell chunks before fetching
   [ChunkFetcher] Chunks stored successfully: {stored: 108, written: 108}
   ```
4. æ–‡ä»¶åº”è¯¥èƒ½æ­£å¸¸æ‰“å¼€

## æ€»ç»“

**é—®é¢˜æ ¹æº**ï¼šCouchDB replication åŒæ­¥äº† chunk çš„å…ƒæ•°æ®ä½†æ²¡æœ‰ `data` å­—æ®µï¼Œå¯¼è‡´ `force: true` çš„ `bulkDocs` è®¤ä¸ºæ–‡æ¡£å·²å­˜åœ¨è€Œä¸æ›´æ–°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨é core ä»£ç ä¸­ï¼Œåœ¨ ChunkFetcher æ‹‰å–å‰åˆ é™¤ç©ºå£³ chunksã€‚

**ä¸ºä»€ä¹ˆä¸ä¿®æ”¹ core ä»£ç **ï¼š
1. æˆ‘ä»¬çš„ core ä»£ç å®Œå…¨æ¥è‡ª livesync
2. livesync çš„å®ç°æ˜¯æ­£ç¡®çš„ï¼ˆåœ¨ä»–ä»¬çš„ç¯å¢ƒä¸­èƒ½å·¥ä½œï¼‰
3. é—®é¢˜å¯èƒ½æ˜¯ç¯å¢ƒå·®å¼‚æˆ–è¾¹ç¼˜æƒ…å†µ
4. åœ¨é core ä»£ç ä¸­å¤„ç†æ›´å®‰å…¨ã€æ›´æ˜“ç»´æŠ¤
