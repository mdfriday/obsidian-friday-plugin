# åŒæ­¥è¿›åº¦æ¡ä¼˜åŒ–æ–¹æ¡ˆ - åŸºäº LiveSync æ¶æ„

## éœ€æ±‚åˆ†æ

### æ ¸å¿ƒéœ€æ±‚
åœ¨ç°æœ‰ Friday Plugin çŠ¶æ€æ ï¼ˆå³ä¸Šè§’ï¼‰**ä¸‹æ–¹**æ·»åŠ ä¸€ä¸ªè¿›åº¦æ¡ï¼Œç”¨äºæ˜¾ç¤ºå„ç§åŒæ­¥ä»»åŠ¡çš„å®æ—¶è¿›åº¦ï¼š

1. **ç¬¬ä¸€æ¬¡ä¸Šä¼ **ï¼ˆRebuild Remoteï¼‰
2. **ç¬¬ä¸€æ¬¡ä¸‹è½½**ï¼ˆFetch from Serverï¼‰
3. **æ¯æ¬¡æ‰“å¼€åçš„å¢é‡åŒæ­¥**ï¼ˆPull/Pushï¼‰
4. **è¿›åº¦å¿…é¡»çœŸå®åæ˜ å¼‚æ­¥æ“ä½œçš„å®Œæˆåº¦**
5. **ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆåæ‰æ˜¾ç¤º 100%**

### è®¾è®¡ç›®æ ‡
- ä¿æŒä¸ LiveSync æºç ä¸€è‡´çš„æ¶æ„å’Œé£æ ¼
- ä¸å½±å“ç°æœ‰çŠ¶æ€æ æ˜¾ç¤º
- ä¼˜é›…åœ°èå…¥ Obsidian çš„ UI è®¾è®¡
- ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯éƒ½æœ‰è‰¯å¥½ä½“éªŒ

---

## æ¶æ„è®¾è®¡

### DOM ç»“æ„

åœ¨ç°æœ‰çš„ LiveSync çŠ¶æ€ DOM ä¸‹æ·»åŠ è¿›åº¦æ¡ï¼š

```html
<div class="livesync-status">
  <!-- ç°æœ‰çš„çŠ¶æ€è¡Œ -->
  <div class="livesync-status-statusline">Sync: ğŸŒ€ â†‘ 15 â†“ 42</div>
  
  <!-- âœ¨ æ–°å¢ï¼šè¿›åº¦æ¡å®¹å™¨ -->
  <div class="livesync-status-progressbar">
    <!-- è¿›åº¦æ¡èƒŒæ™¯ -->
    <div class="livesync-progressbar-track">
      <!-- è¿›åº¦æ¡å¡«å…… -->
      <div class="livesync-progressbar-fill" style="width: 45%;">
        <!-- è¿›åº¦æ–‡å­— -->
        <span class="livesync-progressbar-text">Syncing... 45%</span>
      </div>
    </div>
    <!-- ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰ -->
    <div class="livesync-progressbar-label">Downloading files (42/100)</div>
  </div>
  
  <!-- ç°æœ‰çš„å…¶ä»–å…ƒç´  -->
  <div class="livesync-status-messagearea"></div>
  <div class="livesync-status-logmessage"></div>
  <div class="livesync-status-loghistory"></div>
</div>
```

### CSS æ ·å¼

```css
/* ========== è¿›åº¦æ¡å®¹å™¨ ========== */
.livesync-status-progressbar {
    display: none;  /* é»˜è®¤éšè— */
    margin-top: 8px;
    margin-bottom: 4px;
    width: 100%;
    max-width: 500px;  /* é™åˆ¶æœ€å¤§å®½åº¦ */
    margin-left: auto;  /* å³å¯¹é½ */
    pointer-events: none;
    user-select: none;
}

/* å½“æœ‰æ´»åŠ¨ä»»åŠ¡æ—¶æ˜¾ç¤º */
.livesync-status-progressbar.active {
    display: block;
}

/* ========== è¿›åº¦æ¡è½¨é“ ========== */
.livesync-progressbar-track {
    width: 100%;
    height: 6px;
    background-color: rgba(var(--background-modifier-border-rgb), 0.3);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
}

/* ========== è¿›åº¦æ¡å¡«å…… ========== */
.livesync-progressbar-fill {
    height: 100%;
    background: linear-gradient(
        90deg,
        var(--interactive-accent) 0%,
        var(--interactive-accent-hover) 100%
    );
    border-radius: 3px;
    transition: width 0.3s ease-out;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 4px;
    min-width: 0%;
}

/* ä¸ç¡®å®šçŠ¶æ€çš„åŠ¨ç”»ï¼ˆå½“æ— æ³•è®¡ç®—å‡†ç¡®è¿›åº¦æ—¶ï¼‰ */
.livesync-progressbar-fill.indeterminate {
    width: 30% !important;
    background: linear-gradient(
        90deg,
        transparent 0%,
        var(--interactive-accent) 50%,
        transparent 100%
    );
    animation: progressbar-indeterminate 1.5s ease-in-out infinite;
}

@keyframes progressbar-indeterminate {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(300%);
    }
}

/* ========== è¿›åº¦æ–‡å­— ========== */
.livesync-progressbar-text {
    font-size: 10px;
    color: var(--text-on-accent);
    font-weight: 500;
    white-space: nowrap;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* å½“è¿›åº¦æ¡è¶³å¤Ÿå®½æ—¶æ˜¾ç¤ºæ–‡å­— */
.livesync-progressbar-fill[style*="width: 15%"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 1"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 2"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 3"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 4"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 5"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 6"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 7"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 8"] .livesync-progressbar-text,
.livesync-progressbar-fill[style*="width: 9"] .livesync-progressbar-text {
    opacity: 1;
}

/* ========== ä»»åŠ¡æè¿°æ ‡ç­¾ ========== */
.livesync-progressbar-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
    text-align: right;
    opacity: 0.8;
}

/* ========== ç§»åŠ¨ç«¯ä¼˜åŒ– ========== */
.is-mobile .livesync-status-progressbar {
    max-width: 100%;
    margin-left: 0;
}

.is-mobile .livesync-progressbar-track {
    height: 4px;
}

.is-mobile .livesync-progressbar-text {
    font-size: 9px;
}

.is-mobile .livesync-progressbar-label {
    font-size: 10px;
}

/* ========== å®ŒæˆçŠ¶æ€åŠ¨ç”» ========== */
.livesync-progressbar-fill.completed {
    background: linear-gradient(
        90deg,
        var(--color-green) 0%,
        var(--color-green) 100%
    );
}

.livesync-status-progressbar.fadeout {
    animation: progressbar-fadeout 0.5s ease-out forwards;
}

@keyframes progressbar-fadeout {
    0% {
        opacity: 1;
        max-height: 50px;
    }
    100% {
        opacity: 0;
        max-height: 0;
        margin: 0;
    }
}
```

---

## æ ¸å¿ƒå®ç°

### 1. è¿›åº¦è¿½è¸ªå™¨ï¼ˆProgressTrackerï¼‰

åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„è¿›åº¦è¿½è¸ªç±»ï¼š

```typescript
// src/sync/utils/ProgressTracker.ts

export type ProgressTaskType = 
    | "REBUILD_REMOTE"    // ç¬¬ä¸€æ¬¡ä¸Šä¼ 
    | "FETCH_REMOTE"      // ç¬¬ä¸€æ¬¡ä¸‹è½½
    | "PULL"              // å¢é‡ä¸‹è½½
    | "PUSH"              // å¢é‡ä¸Šä¼ 
    | "SYNC";             // åŒå‘åŒæ­¥

export interface ProgressTask {
    type: ProgressTaskType;
    total: number;         // æ€»ä»»åŠ¡æ•°
    current: number;       // å½“å‰å®Œæˆæ•°
    label: string;         // ä»»åŠ¡æè¿°
    subTasks: SubTask[];   // å­ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºå¼‚æ­¥æ“ä½œè¿½è¸ªï¼‰
}

export interface SubTask {
    id: string;
    description: string;
    completed: boolean;
    progress: number;      // 0-100
}

export class ProgressTracker {
    private currentTask: ProgressTask | null = null;
    private onProgressChange: ((task: ProgressTask | null) => void) | null = null;
    
    /**
     * å¼€å§‹ä¸€ä¸ªæ–°ä»»åŠ¡
     */
    startTask(type: ProgressTaskType, total: number, label: string): void {
        this.currentTask = {
            type,
            total,
            current: 0,
            label,
            subTasks: [],
        };
        this.notifyChange();
    }
    
    /**
     * æ›´æ–°ä»»åŠ¡è¿›åº¦
     */
    updateProgress(current: number, label?: string): void {
        if (!this.currentTask) return;
        
        this.currentTask.current = current;
        if (label) {
            this.currentTask.label = label;
        }
        this.notifyChange();
    }
    
    /**
     * å¢åŠ è¿›åº¦
     */
    incrementProgress(delta: number = 1): void {
        if (!this.currentTask) return;
        
        this.currentTask.current += delta;
        // é˜²æ­¢è¶…è¿‡ total
        if (this.currentTask.current > this.currentTask.total) {
            this.currentTask.current = this.currentTask.total;
        }
        this.notifyChange();
    }
    
    /**
     * æ·»åŠ å­ä»»åŠ¡ï¼ˆç”¨äºè¿½è¸ªå¼‚æ­¥æ“ä½œï¼‰
     */
    addSubTask(id: string, description: string): void {
        if (!this.currentTask) return;
        
        this.currentTask.subTasks.push({
            id,
            description,
            completed: false,
            progress: 0,
        });
        this.notifyChange();
    }
    
    /**
     * æ›´æ–°å­ä»»åŠ¡è¿›åº¦
     */
    updateSubTask(id: string, progress: number, completed?: boolean): void {
        if (!this.currentTask) return;
        
        const subTask = this.currentTask.subTasks.find(t => t.id === id);
        if (subTask) {
            subTask.progress = progress;
            if (completed !== undefined) {
                subTask.completed = completed;
            }
            this.notifyChange();
        }
    }
    
    /**
     * å®Œæˆå­ä»»åŠ¡
     */
    completeSubTask(id: string): void {
        this.updateSubTask(id, 100, true);
    }
    
    /**
     * è·å–å½“å‰ä»»åŠ¡çš„æ€»ä½“è¿›åº¦ï¼ˆ0-100ï¼‰
     */
    getOverallProgress(): number {
        if (!this.currentTask) return 0;
        
        const { total, current, subTasks } = this.currentTask;
        
        if (subTasks.length === 0) {
            // æ²¡æœ‰å­ä»»åŠ¡ï¼Œç›´æ¥è®¡ç®—ä¸»ä»»åŠ¡è¿›åº¦
            return total > 0 ? Math.round((current / total) * 100) : 0;
        }
        
        // æœ‰å­ä»»åŠ¡ï¼Œéœ€è¦è€ƒè™‘å­ä»»åŠ¡çš„å®Œæˆæƒ…å†µ
        const mainProgress = total > 0 ? (current / total) : 0;
        const subTaskProgress = subTasks.reduce((sum, task) => sum + task.progress, 0) / subTasks.length / 100;
        
        // ä¸»ä»»åŠ¡å  70%ï¼Œå­ä»»åŠ¡å  30%
        const overall = (mainProgress * 0.7 + subTaskProgress * 0.3) * 100;
        return Math.round(overall);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­ä»»åŠ¡éƒ½å·²å®Œæˆ
     */
    areAllSubTasksCompleted(): boolean {
        if (!this.currentTask) return true;
        return this.currentTask.subTasks.every(t => t.completed);
    }
    
    /**
     * å®Œæˆå½“å‰ä»»åŠ¡
     */
    completeTask(): void {
        if (!this.currentTask) return;
        
        // ç¡®ä¿è¿›åº¦ä¸º 100%
        this.currentTask.current = this.currentTask.total;
        this.currentTask.subTasks.forEach(t => {
            t.completed = true;
            t.progress = 100;
        });
        
        this.notifyChange();
        
        // å»¶è¿Ÿæ¸…é™¤ä»»åŠ¡ï¼ˆè®©ç”¨æˆ·çœ‹åˆ° 100% çš„çŠ¶æ€ï¼‰
        setTimeout(() => {
            this.clearTask();
        }, 1000);
    }
    
    /**
     * æ¸…é™¤å½“å‰ä»»åŠ¡
     */
    clearTask(): void {
        this.currentTask = null;
        this.notifyChange();
    }
    
    /**
     * è·å–å½“å‰ä»»åŠ¡
     */
    getCurrentTask(): ProgressTask | null {
        return this.currentTask;
    }
    
    /**
     * ç›‘å¬è¿›åº¦å˜åŒ–
     */
    onChange(callback: (task: ProgressTask | null) => void): void {
        this.onProgressChange = callback;
    }
    
    /**
     * é€šçŸ¥è¿›åº¦å˜åŒ–
     */
    private notifyChange(): void {
        if (this.onProgressChange) {
            this.onProgressChange(this.currentTask);
        }
    }
}
```

### 2. è¿›åº¦æ¡ UI ç»„ä»¶

åœ¨ `SyncStatusDisplay.ts` ä¸­æ·»åŠ è¿›åº¦æ¡æ˜¾ç¤ºé€»è¾‘ï¼š

```typescript
// src/sync/SyncStatusDisplay.ts

import { ProgressTracker, type ProgressTask } from "./utils/ProgressTracker";

export class SyncStatusDisplay {
    // ... ç°æœ‰å±æ€§ ...
    
    // âœ¨ æ–°å¢ï¼šè¿›åº¦æ¡å…ƒç´ 
    private progressBarContainer?: HTMLDivElement;
    private progressBarTrack?: HTMLDivElement;
    private progressBarFill?: HTMLDivElement;
    private progressBarText?: HTMLSpanElement;
    private progressBarLabel?: HTMLDivElement;
    
    // âœ¨ æ–°å¢ï¼šè¿›åº¦è¿½è¸ªå™¨
    private progressTracker: ProgressTracker;
    
    constructor(plugin: Plugin) {
        this.plugin = plugin;
        this.progressTracker = new ProgressTracker();
        
        // ç›‘å¬è¿›åº¦å˜åŒ–
        this.progressTracker.onChange((task) => {
            this.updateProgressBar(task);
        });
    }
    
    /**
     * è·å–è¿›åº¦è¿½è¸ªå™¨ï¼ˆä¾› FridaySyncCore ä½¿ç”¨ï¼‰
     */
    getProgressTracker(): ProgressTracker {
        return this.progressTracker;
    }
    
    /**
     * åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤ºï¼ˆæ‰©å±•ç°æœ‰æ–¹æ³•ï¼‰
     */
    initialize() {
        // ... ç°æœ‰çš„åˆå§‹åŒ–é€»è¾‘ ...
        
        // âœ¨ åˆ›å»ºè¿›åº¦æ¡å®¹å™¨ï¼ˆåœ¨ statusLine ä¹‹åï¼‰
        if (this.statusDiv) {
            this.progressBarContainer = this.statusDiv.createDiv({ 
                cls: "livesync-status-progressbar" 
            });
            
            this.progressBarTrack = this.progressBarContainer.createDiv({ 
                cls: "livesync-progressbar-track" 
            });
            
            this.progressBarFill = this.progressBarTrack.createDiv({ 
                cls: "livesync-progressbar-fill" 
            });
            
            this.progressBarText = this.progressBarFill.createSpan({ 
                cls: "livesync-progressbar-text" 
            });
            
            this.progressBarLabel = this.progressBarContainer.createDiv({ 
                cls: "livesync-progressbar-label" 
            });
        }
        
        // ... ç»§ç»­ç°æœ‰çš„åˆå§‹åŒ–é€»è¾‘ ...
    }
    
    /**
     * æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
     */
    private updateProgressBar(task: ProgressTask | null): void {
        if (!this.progressBarContainer || !this.progressBarFill || 
            !this.progressBarText || !this.progressBarLabel) {
            return;
        }
        
        if (!task) {
            // æ²¡æœ‰ä»»åŠ¡ï¼Œéšè—è¿›åº¦æ¡ï¼ˆå¸¦æ·¡å‡ºåŠ¨ç”»ï¼‰
            this.progressBarContainer.addClass("fadeout");
            setTimeout(() => {
                this.progressBarContainer?.removeClass("active", "fadeout");
            }, 500);
            return;
        }
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        this.progressBarContainer.addClass("active");
        this.progressBarContainer.removeClass("fadeout");
        
        // è®¡ç®—æ€»ä½“è¿›åº¦
        const progress = this.progressTracker.getOverallProgress();
        const allSubTasksCompleted = this.progressTracker.areAllSubTasksCompleted();
        
        // æ›´æ–°è¿›åº¦æ¡å®½åº¦
        this.progressBarFill.style.width = `${progress}%`;
        
        // æ›´æ–°è¿›åº¦æ–‡å­—
        let progressText = "";
        let labelText = "";
        
        switch (task.type) {
            case "REBUILD_REMOTE":
                progressText = `Uploading ${progress}%`;
                labelText = `Uploading files (${task.current}/${task.total})`;
                break;
            case "FETCH_REMOTE":
                progressText = `Downloading ${progress}%`;
                labelText = `Downloading files (${task.current}/${task.total})`;
                break;
            case "PULL":
                progressText = `Pull ${progress}%`;
                labelText = `Receiving updates (${task.current}/${task.total})`;
                break;
            case "PUSH":
                progressText = `Push ${progress}%`;
                labelText = `Sending updates (${task.current}/${task.total})`;
                break;
            case "SYNC":
                progressText = `Sync ${progress}%`;
                labelText = task.label || `Syncing (${task.current}/${task.total})`;
                break;
        }
        
        // å¦‚æœæœ‰è‡ªå®šä¹‰æ ‡ç­¾ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾
        if (task.label) {
            labelText = task.label;
        }
        
        // å¦‚æœæœ‰æœªå®Œæˆçš„å­ä»»åŠ¡ï¼Œæ˜¾ç¤ºç­‰å¾…çŠ¶æ€
        if (progress >= 95 && !allSubTasksCompleted) {
            const pendingTasks = task.subTasks.filter(t => !t.completed);
            if (pendingTasks.length > 0) {
                progressText = "Finalizing...";
                labelText = `Waiting for ${pendingTasks.length} async operation(s)`;
                
                // ä½¿ç”¨ä¸ç¡®å®šåŠ¨ç”»
                this.progressBarFill.addClass("indeterminate");
            }
        } else {
            this.progressBarFill.removeClass("indeterminate");
        }
        
        // å®ŒæˆçŠ¶æ€
        if (progress >= 100 && allSubTasksCompleted) {
            progressText = "Completed âœ“";
            labelText = "Sync completed";
            this.progressBarFill.addClass("completed");
        } else {
            this.progressBarFill.removeClass("completed");
        }
        
        this.progressBarText.innerText = progressText;
        this.progressBarLabel.innerText = labelText;
    }
}
```

---

## é›†æˆåˆ°åŒæ­¥æµç¨‹

### 1. Fetch from Serverï¼ˆç¬¬ä¸€æ¬¡ä¸‹è½½ï¼‰

```typescript
// src/sync/FridaySyncCore.ts - rebuildLocalFromRemote æ–¹æ³•

async rebuildLocalFromRemote(): Promise<boolean> {
    const progressTracker = this._statusDisplay?.getProgressTracker();
    
    try {
        // ===== Phase 1: å‡†å¤‡å·¥ä½œ =====
        Logger($msg("fridaySync.fetch.preparing") || "Preparing to fetch...", LOG_LEVEL_NOTICE);
        
        // ===== Phase 2: è·å–è¿œç¨‹ä¿¡æ¯ =====
        const remoteDB = await this._replicator?.getRemoteDB(this._settings);
        const remoteInfo = await remoteDB.info();
        const totalDocs = remoteInfo.doc_count || 0;
        
        // âœ¨ å¼€å§‹è¿›åº¦è¿½è¸ª
        progressTracker?.startTask("FETCH_REMOTE", totalDocs, "Fetching from server");
        
        // ===== Phase 3-4: é‡ç½®æœ¬åœ°æ•°æ®åº“ =====
        Logger("Resetting local database...", LOG_LEVEL_INFO);
        if (this._localDatabase) {
            await this._localDatabase.resetDatabase();
        }
        progressTracker?.updateProgress(0, "Database reset");
        
        // ===== Phase 5: åŒæ­¥å…ƒæ•°æ® =====
        Logger(
            $msg("fridaySync.fetch.downloading") || 
            "Downloading files from server...", 
            LOG_LEVEL_NOTICE
        );
        
        // æ·»åŠ å­ä»»åŠ¡ï¼šå…ƒæ•°æ®åŒæ­¥
        progressTracker?.addSubTask("meta-sync", "Syncing metadata");
        
        const result1 = await this._replicator?.replicateAllFromServer(
            this._settings,
            false,
            (current, total) => {
                // æ›´æ–°ä¸»è¿›åº¦ï¼ˆå æ€»è¿›åº¦çš„ 60%ï¼‰
                const metaProgress = Math.round((current / total) * 60);
                progressTracker?.updateProgress(metaProgress, 
                    `Downloading metadata (${current}/${total})`);
            }
        );
        
        progressTracker?.completeSubTask("meta-sync");
        
        if (!result1) {
            throw new Error("Metadata sync failed");
        }
        
        // ===== Phase 6: è·å–æ–‡ä»¶å— =====
        Logger(
            $msg("fridaySync.fetch.fetchingChunks") || 
            "Fetching file chunks...", 
            LOG_LEVEL_NOTICE
        );
        
        // æ·»åŠ å­ä»»åŠ¡ï¼šæ–‡ä»¶å—è·å–
        progressTracker?.addSubTask("chunk-fetch", "Fetching chunks");
        
        await this.fetchAllMissingChunksFromRemote((current, total) => {
            // æ›´æ–°ä¸»è¿›åº¦ï¼ˆ60%-90%ï¼‰
            const chunkProgress = 60 + Math.round((current / total) * 30);
            progressTracker?.updateProgress(chunkProgress,
                `Fetching chunks (${current}/${total})`);
            
            // æ›´æ–°å­ä»»åŠ¡è¿›åº¦
            progressTracker?.updateSubTask("chunk-fetch", 
                Math.round((current / total) * 100));
        });
        
        progressTracker?.completeSubTask("chunk-fetch");
        
        // ===== Phase 7: é‡å»º Vault =====
        Logger(
            $msg("fridaySync.fetch.rebuilding") || 
            "Rebuilding vault from database...", 
            LOG_LEVEL_NOTICE
        );
        
        // æ·»åŠ å­ä»»åŠ¡ï¼šé‡å»º vault
        progressTracker?.addSubTask("vault-rebuild", "Rebuilding vault");
        
        await this.rebuildVaultFromDB((current, total) => {
            // æ›´æ–°ä¸»è¿›åº¦ï¼ˆ90%-100%ï¼‰
            const rebuildProgress = 90 + Math.round((current / total) * 10);
            progressTracker?.updateProgress(rebuildProgress,
                `Rebuilding vault (${current}/${total})`);
            
            // æ›´æ–°å­ä»»åŠ¡è¿›åº¦
            progressTracker?.updateSubTask("vault-rebuild",
                Math.round((current / total) * 100));
        });
        
        progressTracker?.completeSubTask("vault-rebuild");
        
        // ===== å®Œæˆ =====
        progressTracker?.completeTask();
        
        Logger($msg("fridaySync.fetch.completed") || "Fetch completed!", LOG_LEVEL_NOTICE);
        return true;
        
    } catch (error) {
        progressTracker?.clearTask();
        // ... é”™è¯¯å¤„ç† ...
    }
}
```

### 2. Rebuild Remoteï¼ˆç¬¬ä¸€æ¬¡ä¸Šä¼ ï¼‰

```typescript
// src/sync/FridaySyncCore.ts - rebuildRemote æ–¹æ³•

async rebuildRemote(): Promise<boolean> {
    const progressTracker = this._statusDisplay?.getProgressTracker();
    
    try {
        // è·å–æ‰€æœ‰éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
        const allFiles = this._app.vault.getMarkdownFiles();
        const totalFiles = allFiles.length;
        
        // âœ¨ å¼€å§‹è¿›åº¦è¿½è¸ª
        progressTracker?.startTask("REBUILD_REMOTE", totalFiles, "Uploading to server");
        
        // Phase 1: æ‰«ææœ¬åœ°æ–‡ä»¶
        progressTracker?.addSubTask("scan-local", "Scanning local files");
        Logger("Scanning local files...", LOG_LEVEL_NOTICE);
        
        await this.scanAllFilesToDB((current, total) => {
            const scanProgress = Math.round((current / total) * 30);
            progressTracker?.updateProgress(scanProgress,
                `Scanning files (${current}/${total})`);
            progressTracker?.updateSubTask("scan-local",
                Math.round((current / total) * 100));
        });
        
        progressTracker?.completeSubTask("scan-local");
        
        // Phase 2: é‡ç½®è¿œç¨‹æ•°æ®åº“
        progressTracker?.addSubTask("reset-remote", "Resetting remote database");
        Logger("Resetting remote database...", LOG_LEVEL_NOTICE);
        
        await this._replicator?.resetRemoteDatabase(this._settings);
        progressTracker?.completeSubTask("reset-remote");
        
        // Phase 3: ä¸Šä¼ åˆ°æœåŠ¡å™¨
        progressTracker?.addSubTask("upload", "Uploading to server");
        Logger("Uploading files to server...", LOG_LEVEL_NOTICE);
        
        const result = await this._replicator?.sendChunks(
            this._settings,
            undefined,
            true,
            undefined,
            (current, total) => {
                // 30%-100% çš„è¿›åº¦
                const uploadProgress = 30 + Math.round((current / total) * 70);
                progressTracker?.updateProgress(uploadProgress,
                    `Uploading (${current}/${total})`);
                progressTracker?.updateSubTask("upload",
                    Math.round((current / total) * 100));
            }
        );
        
        if (!result) {
            throw new Error("Upload failed");
        }
        
        progressTracker?.completeSubTask("upload");
        
        // å®Œæˆ
        progressTracker?.completeTask();
        Logger("Rebuild remote completed!", LOG_LEVEL_NOTICE);
        return true;
        
    } catch (error) {
        progressTracker?.clearTask();
        // ... é”™è¯¯å¤„ç† ...
    }
}
```

### 3. å¢é‡åŒæ­¥ï¼ˆæ¯æ¬¡æ‰“å¼€ï¼‰

```typescript
// src/sync/core/replication/couchdb/LiveSyncReplicator.ts
// ä¿®æ”¹ openContinuousReplication æ–¹æ³•

async openContinuousReplication(
    setting: RemoteDBSettings,
    showResult: boolean,
    retrying: boolean
): Promise<boolean> {
    const progressTracker = this.env.statusDisplay?.getProgressTracker();
    
    const next = await shareRunningResult("continuousReplication", async () => {
        // ... ç°æœ‰é€»è¾‘ ...
        
        // è·å–éœ€è¦åŒæ­¥çš„å˜æ›´æ•°é‡
        const localInfo = await localDB.info();
        const remoteInfo = await db.info();
        
        const maxPullSeq = Number(String(remoteInfo.update_seq).split("-")[0]);
        const maxPushSeq = Number(String(localInfo.update_seq).split("-")[0]);
        
        this.maxPullSeq = maxPullSeq;
        this.maxPushSeq = maxPushSeq;
        
        // ä¼°ç®—éœ€è¦åŒæ­¥çš„æ–‡æ¡£æ•°
        const estimatedPullDocs = maxPullSeq - this.lastSyncPullSeq;
        const estimatedPushDocs = maxPushSeq - this.lastSyncPushSeq;
        const totalEstimated = estimatedPullDocs + estimatedPushDocs;
        
        if (totalEstimated > 10) {  // åªæœ‰è¶…è¿‡ 10 ä¸ªå˜æ›´æ‰æ˜¾ç¤ºè¿›åº¦æ¡
            // âœ¨ å¼€å§‹è¿›åº¦è¿½è¸ª
            progressTracker?.startTask("SYNC", totalEstimated, 
                `Syncing ${totalEstimated} change(s)`);
        }
        
        // ... ç»§ç»­åŒæ­¥é€»è¾‘ ...
    });
    
    return next;
}

// åœ¨ parseSynchroniseResult ä¸­æ›´æ–°è¿›åº¦
parseSynchroniseResult(docs: Array<PouchDB.Core.ExistingDocument<EntryDoc>>): void {
    const progressTracker = this.env.statusDisplay?.getProgressTracker();
    const currentTask = progressTracker?.getCurrentTask();
    
    if (currentTask && currentTask.type === "SYNC") {
        // æ›´æ–°è¿›åº¦
        progressTracker?.incrementProgress(docs.length);
        
        const progress = progressTracker?.getOverallProgress() || 0;
        if (progress % 10 === 0) {  // æ¯ 10% è¾“å‡ºä¸€æ¬¡æ—¥å¿—
            Logger(`Sync progress: ${progress}%`, LOG_LEVEL_VERBOSE);
        }
    }
    
    // ... ç»§ç»­ç°æœ‰é€»è¾‘ ...
}
```

---

## å¼‚æ­¥æ“ä½œè¿½è¸ª

### å¤„ç†å¼‚æ­¥ä¸Šä¼ çš„è¿›åº¦

å¯¹äºå¼‚æ­¥æ“ä½œï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ã€chunk å¤„ç†ï¼‰ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

```typescript
// src/sync/FridayStorageEventManager.ts

private async storeFileToDB(event: FileEvent, force: boolean = false): Promise<boolean> {
    const progressTracker = this.core?._statusDisplay?.getProgressTracker();
    const currentTask = progressTracker?.getCurrentTask();
    
    // å¦‚æœå½“å‰æœ‰ä¸Šä¼ ä»»åŠ¡ï¼Œæ·»åŠ å­ä»»åŠ¡è¿½è¸ª
    if (currentTask && currentTask.type === "PUSH") {
        const taskId = `upload-${event.args.file.path}`;
        progressTracker?.addSubTask(taskId, `Uploading ${event.args.file.path}`);
        
        try {
            // æ‰§è¡Œä¸Šä¼ 
            const result = await this.core.localDatabase?.entryManager.store(/* ... */);
            
            // å®Œæˆå­ä»»åŠ¡
            progressTracker?.completeSubTask(taskId);
            
            return result;
        } catch (error) {
            // å³ä½¿å¤±è´¥ä¹Ÿè¦ç§»é™¤å­ä»»åŠ¡
            progressTracker?.completeSubTask(taskId);
            throw error;
        }
    }
    
    // ... ç°æœ‰é€»è¾‘ ...
}
```

---

## å›½é™…åŒ–æ¶ˆæ¯

```json
// src/sync/core/common/messagesJson/en.json

{
    "fridaySync.progress.preparing": "Preparing...",
    "fridaySync.progress.downloading": "Downloading files",
    "fridaySync.progress.uploading": "Uploading files",
    "fridaySync.progress.syncing": "Syncing changes",
    "fridaySync.progress.finalizing": "Finalizing...",
    "fridaySync.progress.completed": "Completed",
    "fridaySync.progress.waiting": "Waiting for async operations"
}
```

```json
// src/sync/core/common/messagesJson/zh.json

{
    "fridaySync.progress.preparing": "å‡†å¤‡ä¸­...",
    "fridaySync.progress.downloading": "æ­£åœ¨ä¸‹è½½æ–‡ä»¶",
    "fridaySync.progress.uploading": "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶",
    "fridaySync.progress.syncing": "æ­£åœ¨åŒæ­¥å˜æ›´",
    "fridaySync.progress.finalizing": "æ­£åœ¨å®Œæˆ...",
    "fridaySync.progress.completed": "å·²å®Œæˆ",
    "fridaySync.progress.waiting": "ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ"
}
```

---

## å®Œæ•´ç¤ºä¾‹æ•ˆæœ

### ç¬¬ä¸€æ¬¡ä¸‹è½½ï¼ˆFetch from Serverï¼‰

```
çŠ¶æ€æ ï¼šSync: ğŸŒ€ â†‘ 0 â†“ 245

è¿›åº¦æ¡ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 65%
                                   Downloading 65%
Downloading files (245/380)

ï¼ˆç­‰å¾…å¼‚æ­¥æ“ä½œæ—¶ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” âŸ³
                                   Finalizing...
Waiting for 3 async operation(s)

ï¼ˆå®Œæˆæ—¶ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 100%
                                   Completed âœ“
Fetch completed

ï¼ˆ1ç§’åè‡ªåŠ¨æ·¡å‡ºæ¶ˆå¤±ï¼‰
```

### å¢é‡åŒæ­¥

```
çŠ¶æ€æ ï¼šSync: âš¡ â†‘ 5 (2) â†“ 12 (8)

è¿›åº¦æ¡ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 35%
                                   Sync 35%
Syncing 17 change(s)
```

---

## å®ç°ä¼˜å…ˆçº§

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°æ—¶é—´ |
|-----|--------|---------|
| 1. ProgressTracker ç±» | ğŸ”´ P0 | 2å°æ—¶ |
| 2. CSS æ ·å¼ | ğŸ”´ P0 | 1å°æ—¶ |
| 3. SyncStatusDisplay é›†æˆ | ğŸ”´ P0 | 2å°æ—¶ |
| 4. Fetch from Server é›†æˆ | ğŸŸ¡ P1 | 2å°æ—¶ |
| 5. Rebuild Remote é›†æˆ | ğŸŸ¡ P1 | 2å°æ—¶ |
| 6. å¢é‡åŒæ­¥é›†æˆ | ğŸŸ¡ P1 | 2å°æ—¶ |
| 7. å¼‚æ­¥æ“ä½œè¿½è¸ª | ğŸŸ¢ P2 | 3å°æ—¶ |
| 8. å›½é™…åŒ–å’Œæµ‹è¯• | ğŸŸ¢ P2 | 1å°æ—¶ |

**æ€»é¢„ä¼°æ—¶é—´ï¼š15 å°æ—¶**

---

## æ€»ç»“

### æ ¸å¿ƒç‰¹ç‚¹

1. **å®Œå…¨åŸºäº LiveSync æ¶æ„**ï¼šDOM ç»“æ„ã€CSS ç±»åã€æ˜¾ç¤ºé€»è¾‘éƒ½ä¸ LiveSync ä¸€è‡´
2. **çœŸå®åæ˜ è¿›åº¦**ï¼šä½¿ç”¨ `ProgressTracker` è¿½è¸ªä¸»ä»»åŠ¡å’Œå­ä»»åŠ¡
3. **å¼‚æ­¥æ“ä½œæ„ŸçŸ¥**ï¼šé€šè¿‡å­ä»»åŠ¡æœºåˆ¶ï¼Œç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆæ‰æ˜¾ç¤º 100%
4. **ä¼˜é›…çš„ UI**ï¼šå¹³æ»‘åŠ¨ç”»ã€æ·¡å…¥æ·¡å‡ºã€ç§»åŠ¨ç«¯ä¼˜åŒ–
5. **æœ€å°ä¾µå…¥**ï¼šä¸æ”¹å˜ç°æœ‰çŠ¶æ€æ æ˜¾ç¤ºï¼Œåªæ˜¯åœ¨ä¸‹æ–¹æ·»åŠ è¿›åº¦æ¡

### æŠ€æœ¯äº®ç‚¹

- **å­ä»»åŠ¡æœºåˆ¶**ï¼šè§£å†³å¼‚æ­¥æ“ä½œè¿›åº¦è¿½è¸ªé—®é¢˜
- **Reactive æ¨¡å¼**ï¼šä¸ LiveSync çš„ reactive æ¶æ„æ— ç¼é›†æˆ
- **æ¸è¿›å¼æ˜¾ç¤º**ï¼šåªæœ‰ä»»åŠ¡é‡è¶³å¤Ÿå¤§æ—¶æ‰æ˜¾ç¤ºè¿›åº¦æ¡
- **æ™ºèƒ½åŠ¨ç”»**ï¼šä¸ç¡®å®šè¿›åº¦æ—¶ä½¿ç”¨åŠ¨ç”»ï¼Œå®Œæˆæ—¶è‡ªåŠ¨æ·¡å‡º

è¿™ä¸ªæ–¹æ¡ˆå®Œå…¨éµå¾ª LiveSync çš„è®¾è®¡å“²å­¦å’Œä»£ç é£æ ¼ï¼Œç¡®ä¿ä¸ç°æœ‰ä»£ç åº“çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ï¼

