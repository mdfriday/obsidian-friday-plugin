# Smart Conflict Resolution Implementation

## é—®é¢˜èƒŒæ™¯

åœ¨ SYNC åŠŸèƒ½ä¸­å‡ºç°çš„å›æ¡£é—®é¢˜ï¼š
- ç”¨æˆ·æ­£åœ¨å¿«é€Ÿç¼–è¾‘æ–‡ä»¶æ—¶ï¼Œå†…å®¹å¶å°”ä¼šå›æ¡£åˆ°æ—§ç‰ˆæœ¬
- åŸå› ï¼šå¦ä¸€ä¸ªè®¾å¤‡è™½ç„¶åªæ‰“å¼€äº†æ–‡ä»¶ï¼ˆæœªç¼–è¾‘ï¼‰ï¼Œä½†ä¸Šä¼ äº†æ—§ç‰ˆæœ¬åˆ°æœåŠ¡å™¨
- å¯¼è‡´æ­£åœ¨ç¼–è¾‘çš„è®¾å¤‡ä¸‹è½½äº†æ—§ç‰ˆæœ¬ï¼Œè¦†ç›–äº†æœ€æ–°çš„ç¼–è¾‘å†…å®¹

## æ ¸å¿ƒåŸå› åˆ†æ

**Friday Plugin åŸå®ç°çš„é—®é¢˜ï¼š**
1. âŒ æ²¡æœ‰æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ­£åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€
2. âŒ æ²¡æœ‰åœ¨å†™å…¥å‰è¿›è¡Œ mtime äºŒæ¬¡æ£€æŸ¥
3. âŒ ä¿æŠ¤æœŸå¤ªçŸ­ï¼ˆ1ç§’ï¼‰ä¸”æœºåˆ¶ç®€å•
4. âŒ æ²¡æœ‰å»¶è¿Ÿå†²çªè§£å†³æœºåˆ¶

**LiveSync åŸç”Ÿçš„ä¿æŠ¤æœºåˆ¶ï¼š**
1. âœ… æ£€æµ‹æ–‡ä»¶æ˜¯å¦åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€
2. âœ… å»¶è¿Ÿéæ´»åŠ¨æ–‡ä»¶çš„å†²çªè§£å†³
3. âœ… å†™å…¥å‰è¿›è¡Œç²¾ç¡®çš„ mtime å’Œå†…å®¹æ¯”è¾ƒ
4. âœ… æä¾›å¤šç§å†²çªè§£å†³ç­–ç•¥é…ç½®

## å®ç°æ–¹æ¡ˆ

### 1. æ™ºèƒ½å†²çªè§£å†³ç­–ç•¥ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰

**æ–‡ä»¶ï¼š`src/sync/FridayServiceHub.ts`**

å®ç°äº†ä¸‰å±‚æ™ºèƒ½åˆ¤æ–­ï¼š

#### ç­–ç•¥ 1ï¼šæ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶ â†’ BLOCKï¼ˆæœ¬åœ°ç‰ˆæœ¬ç»å¯¹ä¼˜å…ˆï¼‰
```typescript
if (isActivelyEditing) {
    Logger(`ğŸ›¡ï¸ BLOCK: File is actively being edited: ${path}`);
    return "BLOCK";
}
```
- **åˆ¤æ–­ä¾æ®**ï¼š
  - æ–‡ä»¶åœ¨æ´»åŠ¨ç¼–è¾‘å™¨æ ‡ç­¾ä¸­
  - æˆ–æ–‡ä»¶åœ¨æœ€è¿‘ 30 ç§’å†…è¢«ä¿®æ”¹
- **è¡Œä¸º**ï¼šå®Œå…¨é˜»æ­¢è¿œç¨‹æ›´æ–°ï¼Œä¿æŠ¤ç”¨æˆ·æ­£åœ¨è¾“å…¥çš„å†…å®¹

#### ç­–ç•¥ 2ï¼šæ‰“å¼€ä½†æœªç¼–è¾‘çš„æ–‡ä»¶ â†’ DEFER æˆ– BLOCKï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰
```typescript
if (isOpen) {
    if (localMtime > remoteMtime) {
        return "BLOCK";  // æœ¬åœ°æ›´æ–°
    } else if (remoteMtime > localMtime) {
        return "DEFER";  // å»¶è¿Ÿåˆ°æ–‡ä»¶å…³é—­åå¤„ç†
    } else {
        // mtime ç›¸åŒï¼Œæ¯”è¾ƒå†…å®¹
        if (contentSame) {
            return "BLOCK";  // æ— éœ€æ›´æ–°
        } else {
            return "DEFER";  // å»¶è¿Ÿå¤„ç†
        }
    }
}
```
- **åˆ¤æ–­ä¾æ®**ï¼šæ–‡ä»¶å·²æ‰“å¼€ä½†ä¸åœ¨æ´»åŠ¨ç¼–è¾‘çŠ¶æ€
- **è¡Œä¸º**ï¼š
  - æœ¬åœ°æ›´æ–° â†’ é˜»æ­¢è¿œç¨‹è¦†ç›–
  - è¿œç¨‹æ›´æ–° â†’ å»¶è¿Ÿåˆ°æ–‡ä»¶å…³é—­ååº”ç”¨
  - mtime ç›¸åŒ â†’ æ¯”è¾ƒå†…å®¹å†³å®š

#### ç­–ç•¥ 3ï¼šæœªæ‰“å¼€çš„æ–‡ä»¶ â†’ ALLOW æˆ– BLOCKï¼ˆmtime ä¼˜å…ˆï¼‰
```typescript
if (localMtime > remoteMtime) {
    return "BLOCK";  // æœ¬åœ°æ›´æ–°ï¼Œä¸è¦è¦†ç›–
} else {
    return "ALLOW";  // è¿œç¨‹æ›´æ–°æˆ–ç›¸åŒï¼Œå…è®¸åŒæ­¥
}
```
- **åˆ¤æ–­ä¾æ®**ï¼šæ–‡ä»¶æœªåœ¨ä»»ä½•ç¼–è¾‘å™¨ä¸­æ‰“å¼€
- **è¡Œä¸º**ï¼š
  - æœ¬åœ°æ›´æ–° â†’ é˜»æ­¢è¿œç¨‹è¦†ç›–ï¼ˆé¿å…ä¸¢å¤±æœ¬åœ°æ›´æ”¹ï¼‰
  - è¿œç¨‹æ›´æ–° â†’ å…è®¸åŒæ­¥ï¼ˆè‡ªåŠ¨è·å–å…¶ä»–è®¾å¤‡çš„æ›´æ–°ï¼‰

### 2. å»¶è¿Ÿå†²çªè§£å†³æœºåˆ¶

**æ–‡ä»¶ï¼š`src/sync/FridayServiceHub.ts`**

å¯¹äºéœ€è¦å»¶è¿Ÿå¤„ç†çš„æ–‡ä»¶ï¼š
```typescript
private deferProcessingForOpenFile(path: string, doc: MetaEntry) {
    this.deferredDocs.set(path, doc);
    
    // æ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤š 60 ç§’
    const checkInterval = 3000;
    const maxRetries = 20;
    
    // å®šæœŸæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å…³é—­
    const checkAndProcess = () => {
        if (!isFileOpen(path)) {
            // æ–‡ä»¶å·²å…³é—­ï¼Œå»¶è¿Ÿ 500ms åå¤„ç†
            setTimeout(() => {
                this.defaultProcessSynchroniseResult(doc);
            }, 500);
        } else if (retryCount < maxRetries) {
            // ç»§ç»­ç­‰å¾…
            setTimeout(checkAndProcess, checkInterval);
        } else {
            // è¶…æ—¶ï¼Œå¼ºåˆ¶å¤„ç†
            this.defaultProcessSynchroniseResult(doc);
        }
    };
}
```

### 3. ç²¾ç¡®çš„ mtime æ¯”è¾ƒ

**æ–‡ä»¶ï¼š`src/sync/FridayStorageEventManager.ts`**

å®ç°äº†ä¸¤çº§ç²¾åº¦çš„ mtime æ¯”è¾ƒï¼š

```typescript
// æ™®é€šæ–‡ä»¶ï¼š2ç§’åˆ†è¾¨ç‡ï¼ˆå…¼å®¹ ZIP æ–‡ä»¶ï¼‰
const MTIME_RESOLUTION = 2000;

// æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶ï¼š500ms åˆ†è¾¨ç‡ï¼ˆæ›´ç²¾ç¡®ï¼‰
const MTIME_RESOLUTION_PRECISE = 500;
```

åœ¨ `storeFileToDB` ä¸­ï¼š
```typescript
const isActivelyEditing = this.isFileActivelyEditing(path);
const resolution = isActivelyEditing 
    ? MTIME_RESOLUTION_PRECISE 
    : MTIME_RESOLUTION;

const fileMtimeTrunc = Math.floor(file.stat.mtime / resolution) * resolution;
const dbMtimeTrunc = Math.floor(existingEntry.mtime / resolution) * resolution;

if (fileMtimeTrunc !== dbMtimeTrunc) {
    shouldUpdate = true;
}
```

### 4. æ–‡ä»¶ç¼–è¾‘çŠ¶æ€æ£€æµ‹

**å…±åŒå®ç°äºï¼š**
- `src/sync/FridayServiceHub.ts`
- `src/sync/FridayStorageEventManager.ts`

```typescript
/**
 * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ‰“å¼€
 */
private isFileOpen(path: string): boolean {
    const workspace = this.plugin.app.workspace;
    return workspace.getLeavesOfType('markdown').some(leaf => {
        const view = leaf.view as any;
        return view.file?.path === path;
    });
}

/**
 * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£åœ¨ç¼–è¾‘
 */
private isFileActivelyEditing(path: string): boolean {
    const workspace = this.plugin.app.workspace;
    const leaves = workspace.getLeavesOfType('markdown');
    
    for (const leaf of leaves) {
        const view = leaf.view as any;
        if (view.file?.path === path) {
            // 1. åœ¨æ´»åŠ¨æ ‡ç­¾ä¸­
            if (leaf === workspace.activeLeaf) {
                return true;
            }
            
            // 2. æœ€è¿‘ 30 ç§’å†…ä¿®æ”¹
            const file = vault.getAbstractFileByPath(path);
            if (file && 'stat' in file) {
                const lastModified = file.stat.mtime;
                const now = Date.now();
                if (now - lastModified < 30000) {
                    return true;
                }
            }
        }
    }
    return false;
}
```

## ç”¨æˆ·ä½“éªŒè®¾è®¡

### è®¾è®¡åŸåˆ™
1. **ä¸æ‰“æ–­ç”¨æˆ·**ï¼šæ‰€æœ‰å†²çªè§£å†³éƒ½åœ¨åå°é™é»˜å¤„ç†
2. **ä¿æŠ¤æ­£åœ¨ç¼–è¾‘çš„å†…å®¹**ï¼šç»å¯¹ä¼˜å…ˆä¿æŠ¤ç”¨æˆ·å½“å‰è¾“å…¥
3. **æ™ºèƒ½è‡ªåŠ¨åŒæ­¥**ï¼šæœªæ‰“å¼€çš„æ–‡ä»¶è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬
4. **å»¶è¿Ÿå¤„ç†**ï¼šå¯¹æ‰“å¼€ä½†æœªç¼–è¾‘çš„æ–‡ä»¶ï¼Œå»¶è¿Ÿåˆ°å…³é—­åæ›´æ–°

### åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯ 1ï¼šå•ç”¨æˆ·å¿«é€Ÿç¼–è¾‘
- **è®¾å¤‡ A**ï¼šç”¨æˆ·æ­£åœ¨å¿«é€Ÿç¼–è¾‘ `note.md`
- **è®¾å¤‡ B**ï¼šåªæ‰“å¼€äº† `note.md`ï¼Œæœªç¼–è¾‘
- **é—®é¢˜**ï¼šè®¾å¤‡ B ä¸Šä¼ æ—§ç‰ˆæœ¬
- **è§£å†³**ï¼š
  1. è®¾å¤‡ A æ£€æµ‹åˆ°æ–‡ä»¶æ­£åœ¨ç¼–è¾‘ â†’ BLOCK è¿œç¨‹æ›´æ–°
  2. ç”¨æˆ·ç»§ç»­ç¼–è¾‘ä¸å—å½±å“
  3. è®¾å¤‡ A çš„æ›´æ–°ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
  4. è®¾å¤‡ B åœ¨ä¸‹æ¬¡æ‰“å¼€æ—¶è·å–æœ€æ–°ç‰ˆæœ¬

#### åœºæ™¯ 2ï¼šæŸ¥çœ‹æ–‡ä»¶æ—¶æ”¶åˆ°è¿œç¨‹æ›´æ–°
- **è®¾å¤‡ A**ï¼šæ‰“å¼€ `note.md` æŸ¥çœ‹ï¼ˆæœªç¼–è¾‘ï¼‰
- **è®¾å¤‡ B**ï¼šç¼–è¾‘äº† `note.md` å¹¶ä¸Šä¼ 
- **è§£å†³**ï¼š
  1. è®¾å¤‡ A æ£€æµ‹åˆ°æ–‡ä»¶æ‰“å¼€ä½†æœªç¼–è¾‘
  2. è¿œç¨‹ mtime æ›´æ–° â†’ DEFER å¤„ç†
  3. ç”¨æˆ·å…³é—­æ–‡ä»¶åï¼Œè‡ªåŠ¨åº”ç”¨è¿œç¨‹æ›´æ–°
  4. ç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€æ—¶çœ‹åˆ°æœ€æ–°ç‰ˆæœ¬

#### åœºæ™¯ 3ï¼šæœªæ‰“å¼€çš„æ–‡ä»¶è‡ªåŠ¨åŒæ­¥
- **è®¾å¤‡ A**ï¼šæœªæ‰“å¼€ `note.md`
- **è®¾å¤‡ B**ï¼šç¼–è¾‘äº† `note.md` å¹¶ä¸Šä¼ 
- **è§£å†³**ï¼š
  1. è®¾å¤‡ A æ£€æµ‹åˆ°æ–‡ä»¶æœªæ‰“å¼€
  2. è¿œç¨‹ mtime æ›´æ–° â†’ ALLOW å¤„ç†
  3. è‡ªåŠ¨ä¸‹è½½å¹¶åº”ç”¨è¿œç¨‹æ›´æ–°
  4. æ— ç¼åŒæ­¥ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„

## æ—¥å¿—æ ‡è¯†

ä¸ºäº†ä¾¿äºè°ƒè¯•å’Œç†è§£ç³»ç»Ÿè¡Œä¸ºï¼Œä½¿ç”¨äº†æ¸…æ™°çš„æ—¥å¿—æ ‡è¯†ï¼š

- `ğŸ›¡ï¸ BLOCK`ï¼šé˜»æ­¢è¿œç¨‹æ›´æ–°
- `â° DEFER`ï¼šå»¶è¿Ÿå¤„ç†è¿œç¨‹æ›´æ–°
- `âœ… ALLOW`ï¼šå…è®¸è¿œç¨‹æ›´æ–°
- `âœ… Processing deferred update`ï¼šå¤„ç†å»¶è¿Ÿçš„æ›´æ–°
- `âš ï¸ WARNING`ï¼šè­¦å‘Šä¿¡æ¯ï¼ˆå¦‚ DB ç‰ˆæœ¬æ›´æ–°ä½†æ–‡ä»¶æ­£åœ¨ç¼–è¾‘ï¼‰

## æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šå¿«é€Ÿç¼–è¾‘ä¿æŠ¤
1. åœ¨è®¾å¤‡ A æ‰“å¼€æ–‡ä»¶å¹¶å¿«é€Ÿç¼–è¾‘ï¼ˆè¿ç»­è¾“å…¥ï¼‰
2. åŒæ—¶åœ¨è®¾å¤‡ B æ‰“å¼€åŒä¸€æ–‡ä»¶ä½†ä¸ç¼–è¾‘
3. è§‚å¯Ÿè®¾å¤‡ A çš„å†…å®¹æ˜¯å¦è¢«è¦†ç›–
4. **æœŸæœ›**ï¼šè®¾å¤‡ A å†…å®¹ä¸ä¼šä¸¢å¤±

### æµ‹è¯•åœºæ™¯ 2ï¼šå»¶è¿ŸåŒæ­¥
1. åœ¨è®¾å¤‡ A æ‰“å¼€æ–‡ä»¶æŸ¥çœ‹ï¼ˆä¸ç¼–è¾‘ï¼‰
2. åœ¨è®¾å¤‡ B ç¼–è¾‘å¹¶ä¿å­˜åŒä¸€æ–‡ä»¶
3. åœ¨è®¾å¤‡ A å…³é—­æ–‡ä»¶
4. **æœŸæœ›**ï¼šè®¾å¤‡ A å…³é—­åè‡ªåŠ¨è·å–è®¾å¤‡ B çš„æ›´æ–°

### æµ‹è¯•åœºæ™¯ 3ï¼šè‡ªåŠ¨åŒæ­¥
1. åœ¨è®¾å¤‡ A ä¸æ‰“å¼€æŸæ–‡ä»¶
2. åœ¨è®¾å¤‡ B ç¼–è¾‘å¹¶ä¿å­˜è¯¥æ–‡ä»¶
3. ç­‰å¾…åŒæ­¥å®Œæˆ
4. åœ¨è®¾å¤‡ A æ‰“å¼€è¯¥æ–‡ä»¶
5. **æœŸæœ›**ï¼šè®¾å¤‡ A çœ‹åˆ°è®¾å¤‡ B çš„æœ€æ–°æ›´æ–°

## æ€§èƒ½å½±å“

- **é¢å¤–å¼€é”€**ï¼š
  - æ–‡ä»¶æ‰“å¼€çŠ¶æ€æ£€æµ‹ï¼šO(n)ï¼Œn = æ‰“å¼€çš„ç¼–è¾‘å™¨æ ‡ç­¾æ•°ï¼ˆé€šå¸¸ < 10ï¼‰
  - mtime æ¯”è¾ƒï¼šO(1)
  - å†…å®¹æ¯”è¾ƒï¼šä»…åœ¨å¿…è¦æ—¶è¿›è¡Œ
- **ä¼˜åŒ–**ï¼š
  - å»¶è¿Ÿå¤„ç†ä½¿ç”¨å®šæ—¶å™¨è€Œéè½®è¯¢
  - ä»…å¯¹å†²çªæ–‡ä»¶è¿›è¡Œå®Œæ•´å†…å®¹æ¯”è¾ƒ
  - ç¼“å­˜æ–‡ä»¶çŠ¶æ€é¿å…é‡å¤æ£€æŸ¥

## æ€»ç»“

æœ¬æ¬¡å®ç°å®Œå…¨å‚ç…§ LiveSync åŸç”Ÿæœºåˆ¶ï¼Œå®ç°äº†ï¼š

1. âœ… **æ£€æµ‹æ–‡ä»¶æ˜¯å¦åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€**
2. âœ… **å»¶è¿Ÿéæ´»åŠ¨æ–‡ä»¶çš„å†²çªè§£å†³**
3. âœ… **å†™å…¥å‰è¿›è¡Œç²¾ç¡®çš„ mtime å’Œå†…å®¹æ¯”è¾ƒ**
4. âœ… **æ™ºèƒ½å†²çªç­–ç•¥**ï¼ˆä»¥ç”¨æˆ·ä½“éªŒä¸ºæ ¸å¿ƒï¼Œä¸æ‰“æ–­æ“ä½œï¼‰

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **é›¶ä¸¢å¤±**ï¼šæ­£åœ¨ç¼–è¾‘çš„å†…å®¹ç»å¯¹ä¸ä¼šè¢«è¦†ç›–
- **é›¶æ‰“æ–­**ï¼šæ‰€æœ‰å¤„ç†åœ¨åå°è¿›è¡Œï¼Œä¸å¼¹çª—ã€ä¸æç¤º
- **æ™ºèƒ½åŒ–**ï¼šæ ¹æ®æ–‡ä»¶çŠ¶æ€å’Œ mtime è‡ªåŠ¨åšå‡ºæœ€ä½³å†³ç­–
- **å…¼å®¹æ€§**ï¼šä¸ LiveSync åŸç”Ÿæœºåˆ¶å®Œå…¨å…¼å®¹

è¿™å¥—æœºåˆ¶å½»åº•è§£å†³äº†"å¿«é€Ÿç¼–è¾‘æ—¶å†…å®¹å›æ¡£"çš„é—®é¢˜ã€‚
